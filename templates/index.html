<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ListenUp - Practice English with Podcasts</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
            color: #00d4ff;
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 20px;
        }

        /* Navigation Menu */
        .nav-menu {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .nav-btn {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #00d4ff;
            border-radius: 25px;
            background: transparent;
            color: #00d4ff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        .nav-btn.active {
            background: #00d4ff;
            color: #1a1a2e;
        }

        /* Library Section */
        .library-section {
            display: none;
        }

        .library-section.active {
            display: block;
        }

        .library-empty {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .library-empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .library-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s;
            gap: 12px;
        }

        .library-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .library-item-thumbnail {
            width: 80px;
            height: 45px;
            border-radius: 6px;
            object-fit: cover;
            background: rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .library-item-info {
            flex: 1;
            min-width: 0;
        }

        .library-item-title {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .library-item-meta {
            font-size: 11px;
            color: #888;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .resume-badge {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        .progress-bar-mini {
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .progress-fill-mini {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .library-item-badges {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .library-item-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
            margin-left: 8px;
        }

        .library-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #888;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .library-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .library-action-btn.delete:hover {
            background: rgba(255, 71, 87, 0.2);
            border-color: #ff4757;
            color: #ff4757;
        }

        .library-difficulty-menu {
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 4px;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .library-difficulty-menu.active {
            display: flex;
            gap: 4px;
        }

        .difficulty-option {
            padding: 6px 10px;
            border-radius: 4px;
            border: none;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .difficulty-option.easy {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .difficulty-option.medium {
            background: rgba(255, 200, 0, 0.2);
            color: #ffc800;
        }

        .difficulty-option.hard {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }

        .difficulty-option:hover {
            filter: brightness(1.3);
        }

        .library-item {
            position: relative;
        }

        .library-item-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }

        .badge-youtube {
            background: rgba(255, 0, 0, 0.2);
            color: #ff4444;
        }

        .badge-podcast {
            background: rgba(138, 43, 226, 0.2);
            color: #a855f7;
        }

        .badge-easy {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .badge-medium {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .badge-hard {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        /* Search Section */
        .search-section {
            display: flex;
            gap: 10px;
        }

        .search-input {
            flex: 1;
            padding: 15px 20px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .search-input:focus {
            outline: 2px solid #00d4ff;
        }

        .btn-search {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            background: #00d4ff;
            color: #1a1a2e;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }

        .btn-search:hover {
            background: #00b8e6;
            transform: scale(1.05);
        }

        .btn-search:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* Podcast Info */
        .podcast-info {
            display: none;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .podcast-info.active {
            display: flex;
        }

        .podcast-artwork {
            width: 100px;
            height: 100px;
            border-radius: 10px;
            object-fit: cover;
        }

        .podcast-details h2 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .podcast-details p {
            color: #aaa;
            font-size: 14px;
        }

        /* Episodes List */
        .episodes-section {
            display: none;
        }

        .episodes-section.active {
            display: block;
        }

        .episodes-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #00d4ff;
        }

        .episodes-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .episode-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .episode-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .episode-item.cached {
            border-left: 3px solid #00ff88;
        }

        .episode-info {
            flex: 1;
        }

        .episode-title {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .episode-meta {
            font-size: 12px;
            color: #888;
        }

        .episode-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: bold;
        }

        .badge-cached {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .badge-new {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
        }

        /* Progress */
        .progress-section {
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .status-text {
            margin-bottom: 10px;
            font-size: 14px;
            color: #aaa;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            width: 0%;
            transition: width 0.3s;
        }

        /* Episode Progress Bar */
        .episode-progress-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
            padding: 0 20px;
        }

        .episode-progress-bar {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
            overflow: hidden;
        }

        .episode-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .episode-progress-text {
            font-size: 12px;
            color: #888;
            min-width: 35px;
            text-align: right;
        }

        /* Player Section */
        .player-section {
            display: none;
        }

        .player-section.active {
            display: block;
        }

        .back-btn {
            background: none;
            border: none;
            color: #00d4ff;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .back-btn:hover {
            text-decoration: underline;
        }

        .player-header-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .source-btn {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            color: #00d4ff;
            cursor: pointer;
            font-size: 13px;
        }

        .bookmark-action-btn {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            color: #ffc107;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .bookmark-action-btn:hover {
            background: rgba(255, 193, 7, 0.2);
        }

        .bookmark-action-btn.bookmark-goto {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: #4CAF50;
            padding: 6px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .bookmark-action-btn.bookmark-goto:hover {
            background: rgba(76, 175, 80, 0.2);
        }

        .bookmark-flash {
            animation: bookmarkPulse 0.5s ease-out;
        }

        @keyframes bookmarkPulse {
            0% { transform: scale(1); background: rgba(76, 175, 80, 0.3); }
            50% { transform: scale(1.1); background: rgba(76, 175, 80, 0.5); }
            100% { transform: scale(1); background: rgba(76, 175, 80, 0.1); }
        }

        .source-btn:hover {
            background: rgba(0, 212, 255, 0.2);
            border-color: #00d4ff;
        }

        body.light-mode .source-btn {
            background: rgba(37, 99, 235, 0.1);
            border-color: rgba(37, 99, 235, 0.3);
            color: #2563eb;
        }

        body.light-mode .source-btn:hover {
            background: rgba(37, 99, 235, 0.2);
        }

        .text-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .text-box {
            padding: 20px;
            border-radius: 10px;
            font-size: 18px;
            line-height: 1.6;
            min-height: 80px;
            margin-bottom: 20px;
        }

        .english-box {
            background: rgba(0, 212, 255, 0.1);
            border-left: 4px solid #00d4ff;
        }

        .portuguese-box {
            background: rgba(0, 255, 136, 0.1);
            border-left: 4px solid #00ff88;
            color: #90EE90;
        }

        /* Phonetic Text (Portuguese pronunciation guide) */
        .phonetic-text {
            padding: 10px 20px;
            font-size: 16px;
            font-style: italic;
            color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
            margin-top: -10px;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        body.light-mode .phonetic-text {
            color: #b8860b;
            background: rgba(255, 215, 0, 0.15);
        }

        /* Split text parts (when using rhythm separators) */
        .text-part, .phonetic-part, .translation-part {
            padding: 8px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
            margin-bottom: 4px;
        }

        .text-part:last-child, .phonetic-part:last-child, .translation-part:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .text-part {
            color: inherit;
        }

        .phonetic-part {
            color: #ffd700;
        }

        .translation-part {
            color: #90EE90;
        }

        body.light-mode .text-part {
            color: inherit;
        }

        body.light-mode .phonetic-part {
            color: #b8860b;
        }

        body.light-mode .translation-part {
            color: #2e7d32;
        }

        /* Part numbering (optional visual aid) */
        .text-part::before, .phonetic-part::before, .translation-part::before {
            content: counter(part-counter) ". ";
            counter-increment: part-counter;
            opacity: 0.5;
            font-size: 0.85em;
            margin-right: 4px;
        }

        .english-box, .phonetic-text, .portuguese-box {
            counter-reset: part-counter;
        }

        /* Part action buttons */
        .text-part {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }

        .part-text {
            flex: 1;
            min-width: 120px;
        }

        .part-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }

        .part-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .part-play-btn {
            background: rgba(100, 149, 237, 0.3);
            color: #6495ed;
        }

        .part-play-btn:hover {
            background: rgba(100, 149, 237, 0.5);
            transform: scale(1.1);
        }

        .part-play-btn.playing {
            background: rgba(255, 107, 107, 0.4);
            color: #ff6b6b;
            animation: pulse 1s infinite;
        }

        .part-mic-btn {
            background: rgba(144, 238, 144, 0.3);
            color: #90ee90;
        }

        .part-mic-btn:hover {
            background: rgba(144, 238, 144, 0.5);
            transform: scale(1.1);
        }

        .part-mic-btn.recording {
            background: rgba(255, 107, 107, 0.4);
            color: #ff6b6b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Part pronunciation result */
        .part-pronunciation-result {
            flex-basis: 100%;
            margin-top: 4px;
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            font-size: 0.9em;
        }

        .part-result-score {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .part-result-score.excellent { color: #4ade80; }
        .part-result-score.good { color: #a3e635; }
        .part-result-score.fair { color: #fbbf24; }
        .part-result-score.poor { color: #f87171; }

        .part-result-spoken {
            color: #9ca3af;
            font-size: 0.9em;
        }

        .part-result-error {
            color: #f87171;
        }

        /* Light mode adjustments for part buttons */
        body.light-mode .part-play-btn {
            background: rgba(59, 130, 246, 0.2);
            color: #2563eb;
        }

        body.light-mode .part-play-btn:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        body.light-mode .part-mic-btn {
            background: rgba(34, 197, 94, 0.2);
            color: #16a34a;
        }

        body.light-mode .part-mic-btn:hover {
            background: rgba(34, 197, 94, 0.3);
        }

        body.light-mode .part-pronunciation-result {
            background: rgba(0, 0, 0, 0.05);
        }

        body.light-mode .part-result-spoken {
            color: #6b7280;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-size: 14px;
            color: #aaa;
        }

        .control-select {
            padding: 8px 15px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 25px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-nav {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .btn-nav:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-play {
            background: #00ff88;
            color: #1a1a2e;
            min-width: 100px;
        }

        .btn-play:hover:not(:disabled) {
            background: #00e67a;
        }

        .btn-play.playing {
            background: #ff4757;
        }

        .segment-info {
            text-align: right;
            font-size: 14px;
            color: #aaa;
        }

        .repeat-status {
            font-size: 12px;
            color: #00d4ff;
        }

        #audioPlayer {
            display: none;
        }

        /* Checking Mode */
        .checking-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 200, 0, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 200, 0, 0.3);
        }

        .checking-toggle label {
            font-size: 14px;
            color: #ffc800;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checking-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checking-section {
            display: none;
            margin-bottom: 20px;
        }

        .checking-section.active {
            display: block;
        }

        .checking-input {
            width: 100%;
            padding: 20px;
            font-size: 18px;
            line-height: 1.6;
            border: none;
            border-radius: 10px;
            background: rgba(255, 200, 0, 0.1);
            border-left: 4px solid #ffc800;
            color: #fff;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 15px;
        }

        .checking-input:focus {
            outline: 2px solid #ffc800;
        }

        .checking-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .btn-check {
            background: #ffc800;
            color: #1a1a2e;
            padding: 12px 30px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-check:hover {
            background: #e6b400;
        }

        .btn-check:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .checking-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            display: none;
        }

        .checking-result.active {
            display: block;
        }

        .checking-result.success {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            color: #00ff88;
        }

        .checking-result.fail {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid #ff4757;
            color: #ff4757;
        }

        .checking-result .accuracy {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .checking-result .correction {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .correction-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .correction-text {
            color: #fff;
        }

        .text-hidden {
            display: none !important;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar */
        .episodes-list::-webkit-scrollbar {
            width: 8px;
        }

        .episodes-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        .episodes-list::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
        }

        /* Flash Cards */
        .flashcard-count {
            background: #ff6b6b;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 5px;
        }

        .flashcard-count:empty {
            display: none;
        }

        .flashcards-section {
            display: none;
        }

        .flashcards-section.active {
            display: block;
        }

        .add-flashcard-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }

        .add-flashcard-btn:hover {
            background: #ee5a5a;
            transform: scale(1.05);
        }

        .add-flashcard-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .add-flashcard-btn-inline {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .add-flashcard-btn-inline:hover {
            background: #ee5a5a;
            transform: scale(1.05);
        }

        .pronunciation-btn-inline {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .pronunciation-btn-inline:hover {
            transform: scale(1.05);
        }

        .pronunciation-btn-inline.recording {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            animation: pulse-recording 1s infinite;
        }

        .flashcard-hint {
            font-size: 11px;
            color: #888;
            margin-top: 5px;
        }

        /* Main Practice Pronunciation Styles */
        .pronunciation-practice-main {
            margin: 15px 0;
            text-align: center;
        }

        .pronunciation-btn-main {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .pronunciation-btn-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .pronunciation-btn-main.recording {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            animation: pulse-recording 1s infinite;
        }

        @keyframes pulse-recording {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pronunciation-result-main {
            display: none;
            margin-top: 15px;
            padding: 15px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pronunciation-result-main.active {
            display: block;
        }

        .pronunciation-result-main.excellent {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
        }

        .pronunciation-result-main.good {
            background: rgba(234, 179, 8, 0.1);
            border-color: rgba(234, 179, 8, 0.3);
        }

        .pronunciation-result-main.needs-practice {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .pronunciation-score-main {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .pronunciation-result-main.excellent .pronunciation-score-main {
            color: #22c55e;
        }

        .pronunciation-result-main.good .pronunciation-score-main {
            color: #eab308;
        }

        .pronunciation-result-main.needs-practice .pronunciation-score-main {
            color: #ef4444;
        }

        .pronunciation-feedback-main {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .pronunciation-details-main {
            font-size: 12px;
            color: #aaa;
            line-height: 1.5;
        }

        body.light-mode .pronunciation-result-main {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.light-mode .pronunciation-details-main {
            color: #666;
        }

        .flashcard-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .flashcard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #ff6b6b;
        }

        .flashcard-item-text {
            flex: 1;
            font-size: 14px;
        }

        .flashcard-item-translation {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }

        .flashcard-item-actions {
            display: flex;
            gap: 10px;
        }

        .flashcard-delete-btn {
            background: none;
            border: none;
            color: #ff4757;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
        }

        .flashcard-delete-btn:hover {
            color: #ff6b81;
        }

        .flashcard-practice-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
        }

        .flashcard-empty {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .flashcard-empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* Practice Mode */
        .practice-section {
            display: none;
        }

        .practice-section.active {
            display: block;
        }

        .practice-card {
            background: rgba(255, 107, 107, 0.15);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        .practice-phrase {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 10px;
        }

        .practice-audio-btn {
            background: rgba(255, 107, 107, 0.3);
            border: 2px solid #ff6b6b;
            color: #ff6b6b;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .practice-audio-btn:hover {
            background: rgba(255, 107, 107, 0.5);
            transform: scale(1.05);
        }

        .practice-audio-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .practice-audio-btn.playing {
            background: #ff6b6b;
            color: white;
        }

        .practice-record-btn {
            background: rgba(0, 212, 255, 0.3);
            border: 2px solid #00d4ff;
            color: #00d4ff;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 15px;
            margin-left: 10px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .practice-record-btn:hover {
            background: rgba(0, 212, 255, 0.5);
            transform: scale(1.05);
        }

        .practice-record-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .practice-record-btn.recording {
            background: #ff4757;
            border-color: #ff4757;
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .pronunciation-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }

        .pronunciation-result.active {
            display: block;
        }

        .pronunciation-result.excellent {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            color: #00ff88;
        }

        .pronunciation-result.good {
            background: rgba(255, 200, 0, 0.2);
            border: 1px solid #ffc800;
            color: #ffc800;
        }

        .pronunciation-result.needs-practice {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid #ff4757;
            color: #ff4757;
        }

        .pronunciation-score {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .pronunciation-feedback {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .pronunciation-details {
            font-size: 12px;
            color: #888;
            margin-top: 10px;
        }

        .pronunciation-details strong {
            color: #fff;
        }

        .practice-context {
            font-size: 14px;
            color: #00d4ff;
            font-style: italic;
            padding: 8px 12px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        /* Compact Practice Layout */
        .practice-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }

        .practice-stats {
            flex: 1;
        }

        .btn-next-top {
            padding: 12px 25px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-next-top:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .practice-card.compact {
            padding: 15px;
            margin-bottom: 15px;
        }

        .practice-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            align-items: start;
        }

        @media (max-width: 700px) {
            .practice-grid {
                grid-template-columns: 1fr;
            }
            .practice-divider.vertical {
                width: 100%;
                height: 1px;
            }
        }

        .practice-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .practice-divider.vertical {
            width: 1px;
            background: rgba(255, 255, 255, 0.1);
            align-self: stretch;
        }

        .practice-phrase {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .practice-mini-btns {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            margin-bottom: 8px;
        }

        .mini-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mini-btn.audio {
            background: rgba(255, 107, 107, 0.2);
            border-color: #ff6b6b;
        }

        .mini-btn.audio:hover, .mini-btn.audio.playing {
            background: #ff6b6b;
        }

        .mini-btn.record {
            background: rgba(255, 200, 0, 0.2);
            border-color: #ffc800;
        }

        .mini-btn.record:hover {
            background: rgba(255, 200, 0, 0.4);
        }

        .mini-btn.record.recording {
            background: #ff4757;
            border-color: #ff4757;
            animation: pulse 1s infinite;
        }

        .mini-btn.context.audio {
            background: rgba(0, 212, 255, 0.2);
            border-color: #00d4ff;
        }

        .mini-btn.context.audio:hover, .mini-btn.context.audio.playing {
            background: #00d4ff;
        }

        .mini-btn.context.record {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }

        .mini-btn.context.record:hover {
            background: rgba(0, 255, 136, 0.4);
        }

        .mini-btn.context.record.recording {
            background: #ff4757;
            border-color: #ff4757;
        }

        /* Compact pronunciation result */
        .pronunciation-result.compact-result {
            margin-top: 8px;
            padding: 8px 12px;
            font-size: 12px;
        }

        .pronunciation-result.compact-result .pronunciation-score {
            font-size: 20px;
            margin-right: 8px;
            margin-bottom: 0;
            display: inline;
        }

        .pronunciation-result.compact-result .pronunciation-feedback {
            display: inline;
            font-size: 12px;
            margin-bottom: 0;
        }

        .pronunciation-result.compact-result .pronunciation-details {
            font-size: 10px;
            margin-top: 5px;
        }

        .practice-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .practice-option {
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .practice-option:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ff6b6b;
        }

        .practice-option.correct {
            background: rgba(0, 255, 136, 0.3);
            border-color: #00ff88;
            color: #00ff88;
        }

        .practice-option.wrong {
            background: rgba(255, 71, 87, 0.3);
            border-color: #ff4757;
            color: #ff4757;
        }

        .practice-option.disabled {
            pointer-events: none;
        }

        .practice-result {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .practice-result.active {
            display: block;
        }

        .practice-result.success {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .practice-result.fail {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }

        .practice-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }

        .practice-stat {
            text-align: center;
        }

        .practice-stat-number {
            font-size: 28px;
            font-weight: bold;
        }

        .practice-stat-label {
            font-size: 12px;
            color: #888;
        }

        .practice-nav {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .btn-practice {
            padding: 12px 30px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-practice-next {
            background: #ff6b6b;
            color: white;
        }

        .btn-practice-next:hover {
            background: #ee5a5a;
        }

        .btn-practice-back {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-practice-back:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .start-practice-btn {
            width: 100%;
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .start-practice-btn:hover {
            background: #ee5a5a;
            transform: scale(1.02);
        }

        .start-practice-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* ==================== NEW FEATURES STYLES ==================== */

        /* Stats Panel */
        .stats-panel {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat-item {
            text-align: center;
            min-width: 80px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #00d4ff;
        }

        .stat-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
        }

        .streak-fire {
            color: #ff6b6b;
        }

        /* Header Controls */
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-right {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #888;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .icon-btn.active {
            background: #00d4ff;
            color: #1a1a2e;
        }

        /* Loop Mode */
        .loop-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .loop-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .loop-toggle.active {
            background: rgba(0, 255, 136, 0.3);
            color: #00ff88;
        }

        .loop-toggle input {
            display: none;
        }

        /* Search in transcript */
        .transcript-search {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .transcript-search input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
        }

        .transcript-search input::placeholder {
            color: #666;
        }

        .transcript-search input:focus {
            outline: 2px solid #00d4ff;
        }

        .search-results {
            font-size: 12px;
            color: #888;
            margin-bottom: 10px;
        }

        .search-nav {
            display: flex;
            gap: 5px;
        }

        .search-nav button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            cursor: pointer;
        }

        .search-nav button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Bookmark */
        .bookmark-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
            transition: all 0.2s;
        }

        .bookmark-btn:hover {
            color: #ffc800;
        }

        .bookmark-btn.bookmarked {
            color: #ffc800;
        }

        /* Difficulty Badge */
        .difficulty-selector {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }

        .difficulty-btn {
            padding: 4px 10px;
            border: none;
            border-radius: 12px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .difficulty-btn:hover {
            transform: scale(1.1);
        }

        .difficulty-btn.easy {
            background: rgba(0, 255, 136, 0.3);
            color: #00ff88;
        }

        .difficulty-btn.medium {
            background: rgba(255, 200, 0, 0.3);
            color: #ffc800;
        }

        .difficulty-btn.hard {
            background: rgba(255, 71, 87, 0.3);
            color: #ff4757;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1a1a2e;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h2 {
            color: #00d4ff;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }

        .shortcut-list {
            display: grid;
            gap: 10px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .shortcut-key {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
            padding: 5px 12px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }

        /* Daily Goal */
        .daily-goal {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 10px;
            border-left: 4px solid #00ff88;
        }

        .daily-goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .daily-goal-title {
            font-weight: bold;
            color: #00ff88;
        }

        .daily-goal-progress {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .daily-goal-fill {
            height: 100%;
            background: #00ff88;
            transition: width 0.3s;
        }

        .daily-goal-text {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
        }

        /* Export buttons */
        .export-section {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 8px 15px;
            border: 1px solid #00d4ff;
            border-radius: 8px;
            background: transparent;
            color: #00d4ff;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-btn:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        /* Light mode */
        body.light-mode {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
            color: #333;
        }

        body.light-mode .card {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        body.light-mode .nav-btn {
            border-color: #333;
            color: #333;
        }

        body.light-mode .nav-btn.active {
            background: #333;
            color: #fff;
        }

        body.light-mode .text-box {
            color: #333;
        }

        body.light-mode .portuguese-box {
            color: #2e7d32;
        }

        body.light-mode h1 {
            color: #1976d2;
        }

        /* SRS indicator */
        .srs-level {
            display: inline-flex;
            gap: 3px;
            margin-left: 10px;
        }

        .srs-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
        }

        .srs-dot.filled {
            background: #00ff88;
        }

        .srs-dot.filled.review {
            background: #ff6b6b;
        }

        /* Due for review */
        .flashcard-item.due-review {
            border-left-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.15);
        }

        /* Daily Goal Complete Animation */
        @keyframes goalComplete {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .daily-goal.complete {
            animation: goalComplete 0.5s ease-in-out;
            border-color: #00ff88;
        }

        /* Practice Section Labels */
        .practice-section-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .practice-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 20px 0;
        }

        /* Context buttons - slightly different style */
        .practice-audio-btn.context-btn {
            background: rgba(0, 212, 255, 0.2);
            border-color: #00d4ff;
            color: #00d4ff;
        }

        .practice-audio-btn.context-btn:hover {
            background: rgba(0, 212, 255, 0.4);
        }

        .practice-audio-btn.context-btn.playing {
            background: #00d4ff;
            color: #1a1a2e;
        }

        .practice-record-btn.context-btn {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            color: #00ff88;
        }

        .practice-record-btn.context-btn:hover {
            background: rgba(0, 255, 136, 0.4);
        }

        .practice-record-btn.context-btn.recording {
            background: #ff4757;
            border-color: #ff4757;
            color: white;
        }

        /* Phonetic pronunciation */
        .practice-phonetic {
            font-size: 13px;
            color: #ffc800;
            font-style: italic;
            margin-top: 3px;
            margin-bottom: 5px;
            padding: 5px 10px;
            background: rgba(255, 200, 0, 0.1);
            border-radius: 6px;
            border-left: 2px solid #ffc800;
        }

        .practice-phonetic::before {
            content: " ";
        }

        .context-phonetic {
            font-size: 11px;
            margin-top: 5px;
        }

        /* ==================== MOBILE RESPONSIVE ==================== */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            h1 {
                font-size: 18px;
            }

            .container {
                max-width: 100%;
            }

            .card {
                padding: 10px;
                border-radius: 8px;
                margin-bottom: 10px;
            }

            /* Navigation */
            .nav-menu {
                flex-wrap: wrap;
                gap: 6px;
            }

            .nav-btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            /* Search */
            .search-section {
                flex-direction: column;
                gap: 8px;
            }

            .search-input {
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 10px;
            }

            .btn-search {
                width: 100%;
                padding: 12px;
            }

            /* Text boxes */
            .text-box {
                padding: 10px;
                font-size: 15px;
                min-height: 50px;
                margin-bottom: 8px;
            }

            .phonetic-text {
                font-size: 13px;
                padding: 6px 10px;
                margin-top: -5px;
                margin-bottom: 8px;
            }

            /* Controls */
            .controls {
                flex-direction: column;
                gap: 8px;
            }

            .control-group {
                width: 100%;
                justify-content: space-between;
            }

            .control-select {
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 8px;
            }

            .nav-buttons {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
                gap: 6px;
            }

            .btn {
                padding: 10px 14px;
                font-size: 14px;
            }

            .btn-nav {
                flex: 1;
                min-width: 80px;
            }

            .btn-play {
                flex: 1;
                min-width: 60px;
            }

            .segment-info {
                text-align: center;
                width: 100%;
                font-size: 12px;
            }

            /* Checking mode */
            .checking-toggle {
                padding: 8px;
            }

            .checking-toggle label {
                font-size: 12px;
            }

            .checking-input {
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 10px;
            }

            /* Flash cards */
            .flashcard-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
                padding: 10px;
            }

            .flashcard-actions {
                width: 100%;
                justify-content: flex-end;
            }

            /* Practice */
            .practice-header-row {
                flex-direction: column;
                gap: 8px;
            }

            .btn-next-top {
                width: 100%;
                padding: 10px;
            }

            .practice-phrase {
                font-size: 16px;
            }

            .practice-context {
                font-size: 13px;
            }

            /* Library items */
            .library-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
                padding: 10px;
                position: relative;
            }

            .library-item-actions {
                position: absolute;
                top: 8px;
                right: 8px;
                margin-left: 0;
            }

            .library-difficulty-menu {
                right: 70px;
                top: 8px;
                transform: none;
            }

            /* Loop toggle */
            .loop-toggle {
                padding: 6px 10px;
                font-size: 12px;
            }

            /* Difficulty buttons */
            .difficulty-selector {
                gap: 3px;
            }

            .difficulty-btn {
                width: 22px;
                height: 22px;
                font-size: 9px;
            }

            /* Add flashcard button */
            .add-flashcard-btn {
                font-size: 12px;
                padding: 8px 12px;
            }

            /* Stats */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .stat-card {
                padding: 10px;
            }

            .stat-number {
                font-size: 20px;
            }

            /* Header controls */
            .header-controls {
                padding: 8px 0;
            }

            .stats-panel {
                padding: 8px;
                gap: 10px;
            }

            .stat-value {
                font-size: 14px;
            }

            .stat-label {
                font-size: 10px;
            }

            /* Back button */
            .back-btn {
                padding: 6px 12px;
                font-size: 13px;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            body {
                padding: 3px;
            }

            h1 {
                font-size: 16px;
            }

            .subtitle {
                font-size: 11px;
            }

            .card {
                padding: 8px;
                margin-bottom: 8px;
            }

            .nav-btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            .text-box {
                font-size: 14px;
                padding: 8px;
                min-height: 40px;
            }

            .phonetic-text {
                font-size: 12px;
                padding: 5px 8px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            .control-group label {
                font-size: 11px;
            }

            .practice-stats {
                gap: 8px;
            }

            .practice-stat-number {
                font-size: 16px;
            }

            .practice-phrase {
                font-size: 14px;
            }

            .practice-context {
                font-size: 12px;
            }

            .stats-panel {
                padding: 5px;
                gap: 8px;
            }

            .icon-btn {
                padding: 5px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcutsModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h2> Keyboard Shortcuts</h2>
            <div class="shortcut-list">
                <div class="shortcut-item"><span>Play/Pause</span><span class="shortcut-key">Space</span></div>
                <div class="shortcut-item"><span>Previous sentence</span><span class="shortcut-key"></span></div>
                <div class="shortcut-item"><span>Next sentence</span><span class="shortcut-key"></span></div>
                <div class="shortcut-item"><span>Repeat sentence</span><span class="shortcut-key">R</span></div>
                <div class="shortcut-item"><span>Toggle loop</span><span class="shortcut-key">L</span></div>
                <div class="shortcut-item"><span>Bookmark</span><span class="shortcut-key">B</span></div>
                <div class="shortcut-item"><span>Search</span><span class="shortcut-key">Ctrl+F</span></div>
                <div class="shortcut-item"><span>Close modal</span><span class="shortcut-key">Esc</span></div>
            </div>
            <button class="start-practice-btn" style="margin-top: 20px;" onclick="document.getElementById('shortcutsModal').classList.remove('active')">Close</button>
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="statsModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h2> Your Statistics</h2>
            <div class="stats-panel" style="margin-bottom: 20px;">
                <div class="stat-item">
                    <div class="stat-value" id="totalTimeStudied">0</div>
                    <div class="stat-label">Min. Studied</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalSegments">0</div>
                    <div class="stat-label">Sentences</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalAccuracy">0%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="pronunciationRate">0%</div>
                    <div class="stat-label">Pronunciation</div>
                </div>
            </div>
            <div class="pronunciation-stats" style="margin-bottom: 20px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 12px; text-align: center;">
                <div style="font-size: 14px; color: #888; margin-bottom: 8px;"> Pronunciation Practice</div>
                <div style="display: flex; justify-content: center; gap: 30px;">
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="pronunciationAttempts">0</div>
                        <div style="font-size: 11px; color: #888;">Attempts</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #22c55e;" id="pronunciationSuccesses">0</div>
                        <div style="font-size: 11px; color: #888;">Success (90%)</div>
                    </div>
                </div>
            </div>
            <div class="daily-goal" id="dailyGoalSection">
                <div class="daily-goal-header">
                    <span class="daily-goal-title"> Daily Goal</span>
                    <span id="dailyGoalCounter">0/10 sentences</span>
                </div>
                <div class="daily-goal-progress">
                    <div class="daily-goal-fill" id="dailyGoalFill" style="width: 0%"></div>
                </div>
                <div class="daily-goal-text">Complete 10 sentences per day to keep your streak!</div>
            </div>
            <div style="text-align: center;">
                <label style="display: block; margin-bottom: 10px; color: #888;">Change daily goal:</label>
                <select id="dailyGoalSelect" class="control-select" onchange="updateDailyGoal()">
                    <option value="5">5 sentences</option>
                    <option value="10" selected>10 sentences</option>
                    <option value="15">15 sentences</option>
                    <option value="20">20 sentences</option>
                    <option value="30">30 sentences</option>
                </select>
            </div>
            <button class="start-practice-btn" style="margin-top: 20px;" onclick="document.getElementById('statsModal').classList.remove('active')">Close</button>
        </div>
    </div>

    <div class="container">
        <!-- Header Controls -->
        <div class="header-controls">
            <div class="header-left">
                <h1 style="margin: 0;">ListenUp</h1>
            </div>
            <div class="header-right">
                <button class="icon-btn" onclick="toggleTheme()" title="Toggle theme"></button>
                <button class="icon-btn" onclick="showStats()" title="Statistics"></button>
                <button class="icon-btn" onclick="showShortcuts()" title="Shortcuts"></button>
            </div>
        </div>

        <!-- Stats Panel -->
        <div class="stats-panel">
            <div class="stat-item">
                <div class="stat-value streak-fire" id="streakCount"> 0</div>
                <div class="stat-label">Streak</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="todaySegments">0</div>
                <div class="stat-label">Today</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalWords">0</div>
                <div class="stat-label">Words</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avgAccuracy">--</div>
                <div class="stat-label">Accuracy</div>
            </div>
        </div>

        <p class="subtitle">Practice English with Podcasts</p>

        <!-- Navigation Menu -->
        <div class="nav-menu">
            <button class="nav-btn active" onclick="showSection('home')">Library</button>
            <button class="nav-btn" onclick="showSection('search')">Search</button>
            <button class="nav-btn" onclick="showSection('flashcards')">Flash Cards <span id="flashcardCount" class="flashcard-count"></span></button>
        </div>

        <!-- Library Section (Home) -->
        <div id="librarySection" class="card library-section active">
            <div id="libraryList"></div>
        </div>

        <!-- Search Section -->
        <div id="searchSection" class="card" style="display: none;">
            <div class="search-section">
                <input type="text" id="searchInput" class="search-input"
                       placeholder="Paste Apple Podcasts URL or search by name..."
                       value="">
                <button id="searchBtn" class="btn-search" onclick="searchPodcast()">Search</button>
            </div>
        </div>

        <!-- Flash Cards Section -->
        <div id="flashcardsSection" class="card flashcards-section">
            <div id="flashcardsList">
                <!-- List view -->
                <div id="flashcardsListView">
                    <h3 style="margin-bottom: 20px; color: #ff6b6b;">Suas Expressoes</h3>
                    <div id="flashcardsItems" class="flashcard-list"></div>
                    <button class="start-practice-btn" onclick="startPractice()" id="startPracticeBtn" disabled>
                        Start Practice
                    </button>
                    <div class="export-section">
                        <button class="export-btn" onclick="exportToAnki()"> Export Anki</button>
                        <button class="export-btn" onclick="exportToSRT()"> Export SRT</button>
                        <button class="export-btn" onclick="exportBookmarks()"> Export Bookmarks</button>
                    </div>
                </div>

                <!-- Practice view -->
                <div id="flashcardsPracticeView" class="practice-section">
                    <button class="back-btn" onclick="exitPractice()"> Back to list</button>

                    <div class="practice-header-row">
                        <div class="practice-stats">
                            <div class="practice-stat">
                                <div id="practiceCorrect" class="practice-stat-number" style="color: #00ff88;">0</div>
                                <div class="practice-stat-label">Correct</div>
                            </div>
                            <div class="practice-stat">
                                <div id="practiceWrong" class="practice-stat-number" style="color: #ff4757;">0</div>
                                <div class="practice-stat-label">Wrong</div>
                            </div>
                            <div class="practice-stat">
                                <div id="practiceProgress" class="practice-stat-number" style="color: #ff6b6b;">0/0</div>
                                <div class="practice-stat-label">Progress</div>
                            </div>
                        </div>
                        <button class="btn-next-top" onclick="nextPracticeCard()" id="nextPracticeBtnTop">
                            Next 
                        </button>
                    </div>

                    <div class="practice-card compact">
                        <div class="practice-grid">
                            <!-- Termo isolado -->
                            <div class="practice-column term-column">
                                <div class="practice-section-label">Term</div>
                                <div id="practicePhrase" class="practice-phrase"></div>
                                <div id="practicePhrasePhonetic" class="practice-phonetic"></div>
                                <div class="practice-mini-btns">
                                    <button class="mini-btn audio" onclick="playPracticeAudio('term')" id="practiceAudioBtn" title="Listen"></button>
                                    <button class="mini-btn record" onclick="toggleRecording('term')" id="practiceRecordBtn" title="Record"></button>
                                </div>
                                <div id="pronunciationResultTerm" class="pronunciation-result compact-result">
                                    <span class="pronunciation-score" id="pronunciationScoreTerm"></span>
                                    <span class="pronunciation-feedback" id="pronunciationFeedbackTerm"></span>
                                    <div class="pronunciation-details" id="pronunciationDetailsTerm"></div>
                                </div>
                            </div>

                            <!-- Separador vertical -->
                            <div class="practice-divider vertical"></div>

                            <!-- Frase completa -->
                            <div class="practice-column context-column">
                                <div class="practice-section-label">Full Sentence</div>
                                <div id="practiceContext" class="practice-context"></div>
                                <div id="practiceContextPhonetic" class="practice-phonetic context-phonetic"></div>
                                <div class="practice-mini-btns">
                                    <button class="mini-btn audio context" onclick="playPracticeAudio('context')" id="practiceAudioBtnContext" title="Listen"></button>
                                    <button class="mini-btn record context" onclick="toggleRecording('context')" id="practiceRecordBtnContext" title="Record"></button>
                                </div>
                                <div id="pronunciationResultContext" class="pronunciation-result compact-result">
                                    <span class="pronunciation-score" id="pronunciationScoreContext"></span>
                                    <span class="pronunciation-feedback" id="pronunciationFeedbackContext"></span>
                                    <div class="pronunciation-details" id="pronunciationDetailsContext"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="practiceOptions" class="practice-options"></div>

                    <div id="practiceResult" class="practice-result">
                        <span id="practiceResultText"></span>
                    </div>

                    <div class="practice-nav">
                        <button class="btn-practice btn-practice-next" onclick="nextPracticeCard()" id="nextPracticeBtn" style="display: none;">
                            Next 
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Podcast Info -->
        <div id="podcastInfo" class="card podcast-info">
            <button class="back-btn" onclick="backToSearch()" style="margin-bottom: 15px;"> Back to Search</button>
            <div style="display: flex; align-items: center; gap: 15px;">
                <img id="podcastArtwork" class="podcast-artwork" src="" alt="">
                <div class="podcast-details">
                    <h2 id="podcastName"></h2>
                    <p id="podcastArtist"></p>
                </div>
            </div>
        </div>

        <!-- Episodes List -->
        <div id="episodesSection" class="card episodes-section">
            <div class="episodes-title">Available Episodes</div>
            <div id="episodesList" class="episodes-list"></div>
        </div>

        <!-- Progress -->
        <div id="progressSection" class="card progress-section">
            <div id="statusText" class="status-text">Processing...</div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>

        <!-- Player Section -->
        <div id="playerSection" class="card player-section">
            <div class="player-header-buttons" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="back-btn" onclick="backToEpisodes()"> Back</button>
                    <button class="source-btn" onclick="openSourceUrl()" title="Open original"> Source</button>
                    <button class="bookmark-action-btn" id="setBookmarkBtn" onclick="setManualBookmark()" title="Set bookmark here"> Set</button>
                    <button class="bookmark-action-btn bookmark-goto" id="gotoBookmarkBtn" onclick="gotoManualBookmark()" title="Go to bookmark" style="display: none;"> Go</button>
                </div>
                <label class="checking-toggle-inline" style="display: flex; align-items: center; gap: 5px; font-size: 12px; cursor: pointer;">
                    <input type="checkbox" id="checkingMode" onchange="toggleCheckingMode()">
                    Challenge Mode
                </label>
            </div>

            <!-- Playback Controls - moved to top -->
            <div class="controls" style="margin-top: 10px;">
                <div class="control-group">
                    <label>Repeats:</label>
                    <select id="repeatSelect" class="control-select">
                        <option value="1">1x</option>
                        <option value="2">2x</option>
                        <option value="3" selected>3x</option>
                        <option value="5">5x</option>
                        <option value="10">10x</option>
                        <option value="15">15x</option>
                        <option value="20">20x</option>
                        <option value="25">25x</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Speed:</label>
                    <select id="speedSelect" class="control-select" onchange="changeSpeed()">
                        <option value="0.5">50%</option>
                        <option value="0.75">75%</option>
                        <option value="1" selected>100%</option>
                        <option value="1.25">125%</option>
                        <option value="1.5">150%</option>
                    </select>
                </div>

                <label class="loop-toggle" id="loopToggle" onclick="toggleLoopMode()">
                    <input type="checkbox" id="loopModeCheckbox">
                    <span></span>
                    <span>Loop</span>
                </label>

                <div class="nav-buttons">
                    <button id="prevBtn" class="btn btn-nav" onclick="prevSegment()" disabled>&lt; Previous</button>
                    <button id="playBtn" class="btn btn-play" onclick="togglePlay()" disabled>Play</button>
                    <button id="nextBtn" class="btn btn-nav" onclick="nextSegment()" disabled>Next &gt;</button>
                </div>

                <div class="segment-info">
                    <div id="segmentCount">Sentence 0 of 0</div>
                    <div id="repeatStatus" class="repeat-status"></div>
                </div>

                <!-- Episode Progress Bar -->
                <div class="episode-progress-container">
                    <div class="episode-progress-bar">
                        <div id="episodeProgressFill" class="episode-progress-fill"></div>
                    </div>
                    <div class="episode-progress-text">
                        <span id="episodeProgressPercent">0%</span>
                    </div>
                </div>
            </div>

            <!-- Transcript Search (hidden - not used) -->
            <div class="transcript-search" id="transcriptSearch" style="display: none;">
                <input type="text" id="searchTranscript" placeholder="Search in text..." onkeyup="searchInTranscript(event)">
                <div class="search-nav">
                    <button onclick="prevSearchResult()"></button>
                    <button onclick="nextSearchResult()"></button>
                </div>
            </div>
            <div class="search-results" id="searchResults" style="display: none;"></div>

            <!-- Normal Text Display (hidden when checking mode is on) -->
            <div id="textDisplay">
                <div class="text-label">
                    <span style="display: flex; align-items: center; gap: 10px;">
                        English
                        <button class="bookmark-btn" id="bookmarkBtn" onclick="toggleBookmark()" title="Add to bookmarks"></button>
                        <div class="difficulty-selector">
                            <button class="difficulty-btn" onclick="setDifficulty('easy')" title="Easy">E</button>
                            <button class="difficulty-btn" onclick="setDifficulty('medium')" title="Medium">M</button>
                            <button class="difficulty-btn" onclick="setDifficulty('hard')" title="Hard">H</button>
                        </div>
                        <button class="add-flashcard-btn-inline" onclick="addSelectedToFlashcard()" id="addFlashcardBtnInline" title="Add selected text to Flash Cards">
                            + Flash Card
                        </button>
                        <button class="pronunciation-btn-inline" id="mainPronunciationBtn" onclick="toggleMainPronunciation()" title="Practice pronunciation">
                             Pronunciation
                        </button>
                    </span>
                    <span id="timeRange"></span>
                </div>
                <div id="englishText" class="text-box english-box"></div>
                <div id="englishPhonetic" class="phonetic-text"></div>

                <!-- Pronunciation Result Section -->
                <div class="pronunciation-practice-main" style="margin-top: 10px;">
                    <div id="mainPronunciationResult" class="pronunciation-result-main">
                        <div class="pronunciation-score-main" id="mainPronunciationScore">0%</div>
                        <div class="pronunciation-feedback-main" id="mainPronunciationFeedback"></div>
                        <div class="pronunciation-details-main" id="mainPronunciationDetails"></div>
                    </div>
                </div>


                <div class="text-label">
                    <span>Portuguese</span>
                </div>
                <div id="portugueseText" class="text-box portuguese-box"></div>
            </div>

            <!-- Checking Section (shown when checking mode is on) -->
            <div id="checkingSection" class="checking-section">
                <div class="text-label">
                    <span>Type what you hear in English</span>
                    <span id="timeRangeChecking"></span>
                </div>
                <textarea id="checkingInput" class="checking-input"
                    placeholder="Listen to the audio and type what you hear..."></textarea>
                <button class="btn-check" onclick="checkAnswer()">Check</button>

                <div id="checkingResult" class="checking-result">
                    <div class="accuracy"></div>
                    <div class="correction">
                        <div class="correction-label">Correct transcription:</div>
                        <div class="correction-text"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <audio id="audioPlayer"></audio>

    <script>
        let segments = [];
        let currentIndex = 0;
        let audioPlayer = document.getElementById('audioPlayer');
        let isPlaying = false;
        let currentRepeat = 0;
        let totalRepeats = 3;
        let playbackTimer = null;
        let currentEpisodeUrl = null;
        let currentEpisodeId = null;
        let audioReady = false;
        let audioUnlocked = false;
        let isLoopMode = false;

        // Save/Load episode position
        function saveEpisodePosition() {
            if (currentEpisodeId && currentIndex >= 0) {
                const positions = JSON.parse(localStorage.getItem('episodePositions') || '{}');
                positions[currentEpisodeId] = currentIndex;
                localStorage.setItem('episodePositions', JSON.stringify(positions));
            }
        }

        function loadEpisodePosition(episodeId) {
            const positions = JSON.parse(localStorage.getItem('episodePositions') || '{}');
            return positions[episodeId] || 0;
        }

        // Audio event listeners for debugging
        audioPlayer.addEventListener('canplaythrough', () => {
            console.log('Audio ready to play');
            audioReady = true;
        });

        audioPlayer.addEventListener('error', (e) => {
            console.error('Audio error:', e);
        });

        audioPlayer.addEventListener('loadstart', () => {
            console.log('Audio loading started');
            audioReady = false;
        });

        // Unlock audio on first user interaction (required for iOS)
        function unlockAudio() {
            if (audioUnlocked) return;

            // Create a silent audio context to unlock
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (AudioContext) {
                const ctx = new AudioContext();
                const buffer = ctx.createBuffer(1, 1, 22050);
                const source = ctx.createBufferSource();
                source.buffer = buffer;
                source.connect(ctx.destination);
                source.start(0);
                ctx.resume();
            }

            // Mark as unlocked via AudioContext (don't try to play without valid src)
            audioUnlocked = true;
            console.log('Audio context unlocked');
        }

        // Try to unlock audio on any user interaction
        document.addEventListener('touchstart', unlockAudio, { once: true });
        document.addEventListener('click', unlockAudio, { once: true });

        // Load library on page load
        document.addEventListener('DOMContentLoaded', loadLibrary);

        async function loadLibrary() {
            try {
                const response = await fetch('/api/library');
                const data = await response.json();

                const libraryList = document.getElementById('libraryList');

                if (data.library.length === 0) {
                    libraryList.innerHTML = `
                        <div class="library-empty">
                            <div class="library-empty-icon"></div>
                            <p>Your library is empty</p>
                            <p style="font-size: 14px; margin-top: 10px;">
                                Click "Search" to add podcasts
                            </p>
                        </div>
                    `;
                } else {
                    // Get saved positions from localStorage
                    const positions = JSON.parse(localStorage.getItem('episodePositions') || '{}');

                    libraryList.innerHTML = data.library.map(item => {
                        const difficultyLabel = {
                            'easy': 'Easy',
                            'medium': 'Medium',
                            'hard': 'Hard'
                        }[item.difficulty] || 'Medium';

                        const thumbnailHtml = item.thumbnail
                            ? `<img src="${item.thumbnail}" alt="" class="library-item-thumbnail" onerror="this.style.display='none'">`
                            : `<div class="library-item-thumbnail" style="display: flex; align-items: center; justify-content: center; font-size: 24px;"></div>`;

                        // Check if there's a saved position for this episode
                        const savedPosition = positions[item.id] || 0;
                        const progressPercent = item.segment_count > 0 ? Math.round((savedPosition / item.segment_count) * 100) : 0;
                        const resumeText = savedPosition > 0 ? ` ${savedPosition + 1}/${item.segment_count}` : '';

                        return `
                        <div class="library-item" onclick="loadFromLibrary('${item.id}', '${item.url}')" data-episode-id="${item.id}">
                            ${thumbnailHtml}
                            <div class="library-item-info">
                                <div class="library-item-title">${item.title}</div>
                                <div class="library-item-meta">
                                    <span>${item.segment_count} sentences</span>
                                    ${resumeText ? `<span class="resume-badge">${resumeText}</span>` : ''}
                                </div>
                                ${savedPosition > 0 ? `<div class="progress-bar-mini"><div class="progress-fill-mini" style="width: ${progressPercent}%"></div></div>` : ''}
                            </div>
                            <div class="library-item-badges">
                                <span class="library-item-badge badge-${item.difficulty || 'medium'}" id="badge-${item.id}">
                                    ${difficultyLabel}
                                </span>
                                <span class="library-item-badge ${item.source === 'YouTube' ? 'badge-youtube' : 'badge-podcast'}">
                                    ${item.source}
                                </span>
                            </div>
                            <div class="library-difficulty-menu" id="diff-menu-${item.id}">
                                <button class="difficulty-option easy" onclick="setLibraryDifficulty(event, '${item.id}', 'easy')">Easy</button>
                                <button class="difficulty-option medium" onclick="setLibraryDifficulty(event, '${item.id}', 'medium')">Medium</button>
                                <button class="difficulty-option hard" onclick="setLibraryDifficulty(event, '${item.id}', 'hard')">Hard</button>
                            </div>
                            <div class="library-item-actions">
                                <button class="library-action-btn" onclick="toggleDifficultyMenu(event, '${item.id}')" title="Change difficulty"></button>
                                <button class="library-action-btn delete" onclick="removeFromLibrary(event, '${item.id}')" title="Remove"></button>
                            </div>
                        </div>
                    `}).join('');
                }
            } catch (error) {
                console.error('Error loading library:', error);
            }
        }

        // Library action functions
        async function removeFromLibrary(event, episodeId) {
            event.stopPropagation();
            if (!confirm('Remove this episode from library?')) return;

            try {
                const response = await fetch(`/api/cache/${episodeId}`, { method: 'DELETE' });
                if (response.ok) {
                    // Also remove saved position
                    const positions = JSON.parse(localStorage.getItem('episodePositions') || '{}');
                    delete positions[episodeId];
                    localStorage.setItem('episodePositions', JSON.stringify(positions));
                    // Reload library
                    loadLibrary();
                } else {
                    alert('Error removing episode');
                }
            } catch (error) {
                console.error('Error removing from library:', error);
                alert('Error removing episode');
            }
        }

        function toggleDifficultyMenu(event, episodeId) {
            event.stopPropagation();
            // Close all other menus
            document.querySelectorAll('.library-difficulty-menu').forEach(menu => {
                if (menu.id !== `diff-menu-${episodeId}`) {
                    menu.classList.remove('active');
                }
            });
            // Toggle this menu
            const menu = document.getElementById(`diff-menu-${episodeId}`);
            menu.classList.toggle('active');
        }

        async function setLibraryDifficulty(event, episodeId, difficulty) {
            event.stopPropagation();

            try {
                const response = await fetch(`/api/cache/${episodeId}/difficulty`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ difficulty })
                });

                if (response.ok) {
                    // Update badge visually
                    const badge = document.getElementById(`badge-${episodeId}`);
                    if (badge) {
                        badge.className = `library-item-badge badge-${difficulty}`;
                        badge.textContent = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
                    }
                    // Close menu
                    document.getElementById(`diff-menu-${episodeId}`).classList.remove('active');
                }
            } catch (error) {
                console.error('Error setting difficulty:', error);
            }
        }

        // Close difficulty menus when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.library-difficulty-menu').forEach(menu => {
                menu.classList.remove('active');
            });
        });

        async function loadFromLibrary(episodeId, url) {
            currentEpisodeUrl = url;
            currentEpisodeId = episodeId;

            // Hide all sections and show progress
            document.getElementById('librarySection').classList.remove('active');
            document.getElementById('searchSection').style.display = 'none';
            document.getElementById('progressSection').classList.add('active');
            document.getElementById('statusText').textContent = 'Loading...';
            document.getElementById('progressFill').style.width = '20%';

            try {
                const response = await fetch(`/api/cache/${episodeId}`);
                const data = await response.json();

                if (data.segments) {
                    segments = data.segments;

                    // Load saved position for this episode
                    const savedPosition = loadEpisodePosition(episodeId);
                    currentIndex = Math.min(savedPosition, segments.length - 1);

                    // Process to get audio path (will re-download if needed)
                    document.getElementById('statusText').textContent = 'Preparing audio...';
                    document.getElementById('progressFill').style.width = '30%';

                    const processResponse = await fetch('/api/process', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: currentEpisodeUrl })
                    });
                    const processData = await processResponse.json();

                    // If audio needs to be re-downloaded, poll for status
                    if (processData.status === 'started') {
                        document.getElementById('statusText').textContent = 'Downloading audio...';
                        await waitForAudioReady();
                    } else {
                        // Audio is cached, load it directly
                        document.getElementById('statusText').textContent = 'Loading audio...';
                        document.getElementById('progressFill').style.width = '80%';
                    }

                    // Now load the audio
                    loadAudioAndShowPlayer();
                }
            } catch (error) {
                alert('Error loading: ' + error.message);
                showSection('home');
            }
        }

        async function waitForAudioReady() {
            return new Promise((resolve) => {
                const checkStatus = async () => {
                    try {
                        const response = await fetch('/api/status');
                        const data = await response.json();

                        document.getElementById('statusText').textContent = data.message;
                        document.getElementById('progressFill').style.width = data.progress + '%';

                        if (data.is_processing) {
                            setTimeout(checkStatus, 500);
                        } else {
                            resolve();
                        }
                    } catch (e) {
                        resolve();
                    }
                };
                checkStatus();
            });
        }

        function loadAudioAndShowPlayer() {
            audioPlayer.src = '/api/audio?' + Date.now();

            audioPlayer.oncanplaythrough = function() {
                audioPlayer.oncanplaythrough = null;
                audioPlayer.onerror = null;
                showPlayer();
            };

            audioPlayer.onerror = function(e) {
                audioPlayer.oncanplaythrough = null;
                audioPlayer.onerror = null;
                console.error('Audio load error:', e);
                alert('Error loading audio. Please try again.');
                showSection('home');
            };

            // Timeout fallback
            setTimeout(() => {
                if (document.getElementById('progressSection').classList.contains('active')) {
                    audioPlayer.oncanplaythrough = null;
                    audioPlayer.onerror = null;
                    showPlayer();
                }
            }, 5000);
        }

        function showSection(section) {
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));

            // Hide ALL sections for clean navigation
            document.getElementById('librarySection').classList.remove('active');
            document.getElementById('searchSection').style.display = 'none';
            document.getElementById('flashcardsSection').classList.remove('active');
            document.getElementById('podcastInfo').classList.remove('active');
            document.getElementById('episodesSection').classList.remove('active');
            document.getElementById('progressSection').classList.remove('active');
            document.getElementById('playerSection').classList.remove('active');

            if (section === 'home') {
                document.querySelectorAll('.nav-btn')[0].classList.add('active');
                document.getElementById('librarySection').classList.add('active');
                loadLibrary();
            } else if (section === 'search') {
                document.querySelectorAll('.nav-btn')[1].classList.add('active');
                document.getElementById('searchSection').style.display = 'block';
            } else if (section === 'flashcards') {
                document.querySelectorAll('.nav-btn')[2].classList.add('active');
                document.getElementById('flashcardsSection').classList.add('active');
                loadFlashcards();
            }
        }

        async function searchPodcast() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('Please enter a URL or search term');
                return;
            }

            const searchBtn = document.getElementById('searchBtn');
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<span class="spinner"></span>Buscando...';

            try {
                const response = await fetch('/api/podcast/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });

                const data = await response.json();

                if (data.podcast) {
                    // Hide search section to show only results
                    document.getElementById('searchSection').style.display = 'none';

                    // Show podcast/playlist info
                    document.getElementById('podcastArtwork').src = data.podcast.artwork;
                    document.getElementById('podcastName').textContent = data.podcast.name;
                    document.getElementById('podcastArtist').textContent = data.podcast.artist;
                    document.getElementById('podcastInfo').classList.add('active');

                    // Show episodes/videos
                    const episodesList = document.getElementById('episodesList');
                    episodesList.innerHTML = data.episodes.map(ep => `
                        <div class="episode-item ${ep.cached ? 'cached' : ''}" onclick="selectEpisode('${ep.url}', '${ep.title.replace(/'/g, "\\'")}')">
                            <div class="episode-info">
                                <div class="episode-title">${ep.title}</div>
                                <div class="episode-meta">${ep.date}  ${formatDuration(ep.duration)}</div>
                            </div>
                            <span class="episode-badge ${ep.cached ? 'badge-cached' : 'badge-new'}">
                                ${ep.cached ? 'Em cache' : 'Novo'}
                            </span>
                        </div>
                    `).join('');

                    document.getElementById('episodesSection').classList.add('active');
                } else if (data.podcasts) {
                    alert('Please use the full Apple Podcasts URL');
                } else if (data.error) {
                    alert(data.error);
                } else {
                    alert('No results found');
                }

            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search';
            }
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}min`;
        }

        let currentEpisodeTitle = '';

        async function selectEpisode(url, title = '') {
            currentEpisodeUrl = url;
            currentEpisodeTitle = title;

            // Hide all search-related sections
            document.getElementById('podcastInfo').classList.remove('active');
            document.getElementById('episodesSection').classList.remove('active');
            document.getElementById('progressSection').classList.add('active');

            try {
                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, title })
                });

                const data = await response.json();

                if (data.status === 'cached') {
                    // Load from cache
                    await loadCachedEpisode(data.episode_id);
                } else {
                    // Poll for status
                    pollStatus();
                }

            } catch (error) {
                alert('Error: ' + error.message);
                backToEpisodes();
            }
        }

        async function loadCachedEpisode(episodeId) {
            currentEpisodeId = episodeId;
            document.getElementById('statusText').textContent = 'Loading from cache...';
            document.getElementById('progressFill').style.width = '30%';

            const response = await fetch(`/api/cache/${episodeId}`);
            const data = await response.json();

            if (data.segments) {
                segments = data.segments;

                // Load saved position for this episode
                const savedPosition = loadEpisodePosition(episodeId);
                currentIndex = Math.min(savedPosition, segments.length - 1);

                // Start processing to get audio (will re-download if needed)
                document.getElementById('statusText').textContent = 'Preparing audio...';

                const processResponse = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: currentEpisodeUrl })
                });
                const processData = await processResponse.json();

                // If audio needs to be re-downloaded, poll for status
                if (processData.status === 'started') {
                    document.getElementById('statusText').textContent = 'Downloading audio...';
                    await waitForAudioReady();
                } else {
                    document.getElementById('statusText').textContent = 'Loading audio...';
                    document.getElementById('progressFill').style.width = '80%';
                }

                // Now load the audio
                loadAudioAndShowPlayer();
            }
        }

        async function pollStatus() {
            const response = await fetch('/api/status');
            const data = await response.json();

            document.getElementById('statusText').textContent = data.message;
            document.getElementById('progressFill').style.width = data.progress + '%';

            if (data.is_processing) {
                setTimeout(pollStatus, 500);
            } else {
                if (data.error) {
                    alert('Error: ' + data.error);
                    backToEpisodes();
                } else if (data.segment_count > 0) {
                    await loadSegments();
                }
            }
        }

        async function loadSegments() {
            // Get episode ID from status
            const statusResponse = await fetch('/api/status');
            const statusData = await statusResponse.json();
            if (statusData.episode_id) {
                currentEpisodeId = statusData.episode_id;
            }

            const response = await fetch('/api/segments');
            const data = await response.json();

            segments = data.segments;
            currentIndex = 0; // New episodes start at 0

            loadAudioAndShowPlayer();
        }

        function showPlayer() {
            document.getElementById('progressSection').classList.remove('active');
            document.getElementById('playerSection').classList.add('active');

            updateDisplay();
            enableControls(true);
            updateManualBookmarkButtons();
        }

        function backToEpisodes() {
            stopPlayback();
            document.getElementById('playerSection').classList.remove('active');
            document.getElementById('progressSection').classList.remove('active');
            document.getElementById('episodesSection').classList.remove('active');
            showSection('home');
        }

        function backToSearch() {
            document.getElementById('podcastInfo').classList.remove('active');
            document.getElementById('episodesSection').classList.remove('active');
            showSection('search');
        }

        function openSourceUrl() {
            if (currentEpisodeUrl) {
                window.open(currentEpisodeUrl, '_blank');
            } else {
                alert('URL de origem no disponvel');
            }
        }

        function updateDisplay() {
            if (segments.length === 0) return;

            const segment = segments[currentIndex];
            const phoneticText = toPortuguesePhonetic(segment.text);

            // Check if phonetic has rhythm separators (/)
            if (phoneticText.includes(' / ')) {
                // Split phonetic, english and translation by parts
                const phoneticParts = phoneticText.split(' / ');
                const englishParts = splitTextToMatchPhonetic(segment.text, phoneticParts.length);
                const translationParts = splitTranslation(segment.translation, phoneticParts.length);

                // Calculate time duration per part based on word count proportion
                const segmentDuration = segment.end - segment.start;

                // Count words in each part to calculate proportional time
                const wordCounts = englishParts.map(part => part.split(/\s+/).filter(w => w).length);
                const totalWords = wordCounts.reduce((sum, count) => sum + count, 0);

                // Calculate start/end times for each part based on word proportion
                const partTimes = [];
                let currentTime = segment.start;
                for (let i = 0; i < englishParts.length; i++) {
                    const proportion = totalWords > 0 ? wordCounts[i] / totalWords : 1 / englishParts.length;
                    const partDuration = segmentDuration * proportion;
                    partTimes.push({
                        start: currentTime,
                        end: currentTime + partDuration
                    });
                    currentTime += partDuration;
                }

                // Create aligned display with parts and action buttons
                const englishHtml = englishParts.map((part, i) => {
                    const partStart = partTimes[i].start;
                    const partEnd = partTimes[i].end;
                    const escapedPart = part.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    return `<div class="text-part">
                        <span class="part-text">${part}</span>
                        <span class="part-actions">
                            <button class="part-btn part-play-btn" onclick="playPart(${partStart}, ${partEnd}, ${i})" title="Ouvir este trecho"></button>
                            <button class="part-btn part-mic-btn" onclick="practicePart('${escapedPart}', ${i})" title="Praticar pronncia"></button>
                        </span>
                    </div>`;
                }).join('');

                const phoneticHtml = phoneticParts.map((part, i) =>
                    `<div class="phonetic-part"><span class="part-phonetic-text">${part}</span></div>`
                ).join('');

                const translationHtml = translationParts.map((part, i) =>
                    `<div class="translation-part"><span class="part-translation-text">${part}</span></div>`
                ).join('');

                document.getElementById('englishText').innerHTML = englishHtml;
                document.getElementById('englishPhonetic').innerHTML = phoneticHtml;
                document.getElementById('portugueseText').innerHTML = translationHtml;
            } else {
                // No separators, display normally
                document.getElementById('englishText').textContent = segment.text;
                document.getElementById('englishPhonetic').textContent = phoneticText;
                document.getElementById('portugueseText').textContent = segment.translation;
            }

            document.getElementById('timeRange').textContent = segment.time_range;
            document.getElementById('segmentCount').textContent = `Sentence ${currentIndex + 1} of ${segments.length}`;

            // Update episode progress bar
            const progressPercent = segments.length > 0 ? ((currentIndex + 1) / segments.length) * 100 : 0;
            document.getElementById('episodeProgressFill').style.width = `${progressPercent}%`;
            document.getElementById('episodeProgressPercent').textContent = `${Math.round(progressPercent)}%`;

            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('nextBtn').disabled = currentIndex === segments.length - 1;
        }

        // Split English text to match the number of phonetic parts
        function splitTextToMatchPhonetic(text, numParts) {
            const words = text.split(/\s+/);
            const wordsPerPart = Math.ceil(words.length / numParts);
            const parts = [];

            for (let i = 0; i < numParts; i++) {
                const start = i * wordsPerPart;
                const end = Math.min(start + wordsPerPart, words.length);
                if (start < words.length) {
                    parts.push(words.slice(start, end).join(' '));
                }
            }

            // If we have fewer parts than needed, add empty ones
            while (parts.length < numParts) {
                parts.push('');
            }

            return parts;
        }

        // Split translation to match the number of parts
        function splitTranslation(translation, numParts) {
            if (!translation) return Array(numParts).fill('');

            // Try to split by punctuation first (., ,, ;, :)
            let parts = translation.split(/[,;]/).map(p => p.trim()).filter(p => p);

            // If we got close to the right number, use those parts
            if (parts.length >= numParts - 1 && parts.length <= numParts + 1) {
                // Adjust to exact number
                while (parts.length < numParts) {
                    parts.push('');
                }
                if (parts.length > numParts) {
                    // Merge last parts
                    const excess = parts.splice(numParts - 1);
                    parts.push(excess.join(', '));
                }
                return parts;
            }

            // Fall back to word-based splitting
            const words = translation.split(/\s+/);
            const wordsPerPart = Math.ceil(words.length / numParts);
            parts = [];

            for (let i = 0; i < numParts; i++) {
                const start = i * wordsPerPart;
                const end = Math.min(start + wordsPerPart, words.length);
                if (start < words.length) {
                    parts.push(words.slice(start, end).join(' '));
                }
            }

            while (parts.length < numParts) {
                parts.push('');
            }

            return parts;
        }

        function enableControls(enabled) {
            document.getElementById('playBtn').disabled = !enabled;
            document.getElementById('prevBtn').disabled = !enabled || currentIndex === 0;
            document.getElementById('nextBtn').disabled = !enabled || currentIndex === segments.length - 1;
        }

        function togglePlay() {
            if (isPlaying) {
                stopPlayback();
            } else {
                startPlayback();
            }
        }

        function startPlayback() {
            if (segments.length === 0) return;

            const segment = segments[currentIndex];
            totalRepeats = parseInt(document.getElementById('repeatSelect').value);
            currentRepeat = 0;

            playSegment(segment);
        }

        function playSegment(segment) {
            currentRepeat++;
            isPlaying = true;

            document.getElementById('playBtn').textContent = 'Stop';
            document.getElementById('playBtn').classList.add('playing');

            // Show loop or repeat status
            document.getElementById('repeatStatus').textContent = isLoopMode
                ? `Loop infinito - Repeticao ${currentRepeat}`
                : `Repeticao ${currentRepeat} de ${totalRepeats}`;

            const speed = parseFloat(document.getElementById('speedSelect').value);
            audioPlayer.playbackRate = speed;

            // Add margin for context: 300ms before and after
            const MARGIN = 0.30; // 300 milliseconds
            const startTime = Math.max(0, segment.start - MARGIN);
            const endTime = segment.end + MARGIN;

            // Set current time and try to play
            try {
                audioPlayer.currentTime = startTime;
            } catch (e) {
                console.error('Error setting currentTime:', e);
            }

            audioPlayer.play().then(() => {
                console.log('Audio playing from', startTime);
            }).catch(e => {
                console.error('Audio play error:', e);
                isPlaying = false;
                document.getElementById('playBtn').textContent = 'Play';
                document.getElementById('playBtn').classList.remove('playing');
            });

            const duration = ((endTime - startTime) * 1000) / speed;
            playbackTimer = setTimeout(() => {
                audioPlayer.pause();

                // Track time studied
                studyStats.totalTimeSeconds += (endTime - startTime);
                saveStats();

                if (isLoopMode && isPlaying) {
                    // In loop mode, keep repeating the same segment infinitely
                    setTimeout(() => {
                        if (isPlaying) {
                            playSegment(segment);
                        }
                    }, 50);
                } else if (currentRepeat < totalRepeats && isPlaying) {
                    setTimeout(() => {
                        if (isPlaying) {
                            playSegment(segment);
                        }
                    }, 50);
                } else {
                    // Auto-advance to next segment after all repetitions
                    if (currentIndex < segments.length - 1) {
                        currentIndex++;
                        updateDisplay();
                        updateCheckingSection();
                        updateBookmarkButton();
                        updateDifficultyButtons();
                        saveEpisodePosition();

                        // Track segment completion
                        studyStats.todaySegments++;
                        studyStats.totalSegments++;
                        studyStats.lastStudyDate = new Date().toDateString();
                        saveStats();
                        updateStatsDisplay();

                        currentRepeat = 0;
                        setTimeout(() => {
                            startPlayback();
                        }, 50);
                    } else {
                        stopPlayback();
                    }
                }
            }, duration);
        }

        function changeSpeed() {
            const speed = parseFloat(document.getElementById('speedSelect').value);
            audioPlayer.playbackRate = speed;
        }

        function stopPlayback() {
            isPlaying = false;
            audioPlayer.pause();

            if (playbackTimer) {
                clearTimeout(playbackTimer);
                playbackTimer = null;
            }

            // Also stop part playback
            if (partPlaybackTimer) {
                clearTimeout(partPlaybackTimer);
                partPlaybackTimer = null;
            }
            isPlayingPart = false;

            document.getElementById('playBtn').textContent = 'Play';
            document.getElementById('playBtn').classList.remove('playing');
            document.getElementById('repeatStatus').textContent = '';

            // Reset part buttons
            document.querySelectorAll('.part-play-btn.playing').forEach(btn => {
                btn.classList.remove('playing');
                btn.textContent = '';
            });
        }

        // ==================== PART PLAYBACK ====================
        let isPlayingPart = false;
        let partPlaybackTimer = null;
        let currentPartRepeat = 0;
        let totalPartRepeats = 3;
        let currentPlayingPartIndex = -1;

        function playPart(startTime, endTime, partIndex) {
            // Stop any current playback
            stopPlayback();

            // Get repeat count from settings
            totalPartRepeats = parseInt(document.getElementById('repeatSelect').value);
            currentPartRepeat = 0;
            currentPlayingPartIndex = partIndex;

            playPartOnce(startTime, endTime, partIndex);
        }

        function playPartOnce(startTime, endTime, partIndex) {
            currentPartRepeat++;
            isPlayingPart = true;

            // Update button to show playing state
            const btn = document.querySelectorAll('.part-play-btn')[partIndex];
            if (btn) {
                btn.classList.add('playing');
                btn.textContent = '';
            }

            // Show repeat status
            document.getElementById('repeatStatus').textContent = `Trecho ${partIndex + 1}: Repetio ${currentPartRepeat} de ${totalPartRepeats}`;

            const speed = parseFloat(document.getElementById('speedSelect').value);
            audioPlayer.playbackRate = speed;

            // Add margin for context (300ms before, 400ms after to capture full words)
            const MARGIN_BEFORE = 0.30;
            const MARGIN_AFTER = 0.40;
            const adjustedStart = Math.max(0, startTime - MARGIN_BEFORE);
            const adjustedEnd = endTime + MARGIN_AFTER;

            try {
                audioPlayer.currentTime = adjustedStart;
            } catch (e) {
                console.error('Error setting currentTime:', e);
            }

            audioPlayer.play().catch(e => {
                console.error('Audio play error:', e);
                stopPartPlayback(partIndex);
            });

            const duration = ((adjustedEnd - adjustedStart) * 1000) / speed;
            partPlaybackTimer = setTimeout(() => {
                audioPlayer.pause();

                if (currentPartRepeat < totalPartRepeats && isPlayingPart) {
                    // Repeat immediately
                    setTimeout(() => {
                        if (isPlayingPart) {
                            playPartOnce(startTime, endTime, partIndex);
                        }
                    }, 50);
                } else {
                    // Done with all repeats
                    stopPartPlayback(partIndex);
                }
            }, duration);
        }

        function stopPartPlayback(partIndex) {
            isPlayingPart = false;
            currentPlayingPartIndex = -1;

            if (partPlaybackTimer) {
                clearTimeout(partPlaybackTimer);
                partPlaybackTimer = null;
            }

            audioPlayer.pause();
            document.getElementById('repeatStatus').textContent = '';

            // Reset button
            const btn = document.querySelectorAll('.part-play-btn')[partIndex];
            if (btn) {
                btn.classList.remove('playing');
                btn.textContent = '';
            }
        }

        // ==================== PART PRONUNCIATION PRACTICE ====================
        let partRecognition = null;
        let isPartRecording = false;
        let currentPracticePartIndex = -1;
        let partRecognitionGotResult = false;

        function practicePart(text, partIndex) {
            // Stop any current recording
            if (isPartRecording) {
                stopPartRecording();
                return;
            }

            // Check if Speech Recognition is available
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Seu navegador no suporta reconhecimento de voz. Tente usar o Chrome.');
                return;
            }

            currentPracticePartIndex = partIndex;
            partRecognitionGotResult = false;

            // Get the mic button
            const btn = document.querySelectorAll('.part-mic-btn')[partIndex];
            if (!btn) return;

            // Hide any previous result for this part
            hidePartPronunciationResult(partIndex);

            partRecognition = initSpeechRecognition();
            if (!partRecognition) return;

            partRecognition.onstart = () => {
                isPartRecording = true;
                btn.classList.add('recording');
                btn.textContent = '';
            };

            partRecognition.onresult = (event) => {
                partRecognitionGotResult = true;
                const transcript = event.results[0][0].transcript;
                const confidence = event.results[0][0].confidence;

                // Compare with expected text
                const expectedText = text.toLowerCase().trim().replace(/[.,!?]/g, '');
                const spokenText = transcript.toLowerCase().trim().replace(/[.,!?]/g, '');

                const similarity = calculateSimilarity(expectedText, spokenText);
                showPartPronunciationResult(partIndex, text, transcript, similarity, confidence);
            };

            partRecognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'no-speech') {
                    showPartPronunciationResult(partIndex, text, '', 0, 0, 'Nenhuma fala detectada. Tente novamente.');
                } else if (event.error === 'audio-capture') {
                    alert('Microfone no encontrado. Verifique as permisses.');
                }
                stopPartRecording();
            };

            partRecognition.onend = () => {
                isPartRecording = false;
                btn.classList.remove('recording');
                btn.textContent = '';

                if (!partRecognitionGotResult) {
                    showPartPronunciationResult(partIndex, text, '', 0, 0, 'No foi possvel reconhecer. Tente novamente.');
                }
            };

            partRecognition.start();
        }

        function stopPartRecording() {
            if (partRecognition) {
                partRecognition.stop();
            }
            isPartRecording = false;

            // Reset button
            const btn = document.querySelectorAll('.part-mic-btn')[currentPracticePartIndex];
            if (btn) {
                btn.classList.remove('recording');
                btn.textContent = '';
            }
        }

        function showPartPronunciationResult(partIndex, expected, spoken, similarity, confidence, errorMsg = null) {
            // Find or create result element
            const textPart = document.querySelectorAll('.text-part')[partIndex];
            if (!textPart) return;

            // Remove any existing result for this part
            const existingResult = textPart.querySelector('.part-pronunciation-result');
            if (existingResult) {
                existingResult.remove();
            }

            const resultDiv = document.createElement('div');
            resultDiv.className = 'part-pronunciation-result';

            if (errorMsg) {
                resultDiv.innerHTML = `<span class="part-result-error">${errorMsg}</span>`;
            } else {
                // similarity already returns 0-100, no need to multiply
                const percentage = Math.round(similarity);
                let resultClass = 'poor';
                let emoji = '';

                if (percentage >= 90) {
                    resultClass = 'excellent';
                    emoji = '';
                } else if (percentage >= 70) {
                    resultClass = 'good';
                    emoji = '';
                } else if (percentage >= 50) {
                    resultClass = 'fair';
                    emoji = '';
                }

                resultDiv.innerHTML = `
                    <div class="part-result-score ${resultClass}">${emoji} ${percentage}%</div>
                    <div class="part-result-spoken">Voc disse: "${spoken}"</div>
                `;
            }

            textPart.appendChild(resultDiv);
        }

        function hidePartPronunciationResult(partIndex) {
            const textPart = document.querySelectorAll('.text-part')[partIndex];
            if (!textPart) return;

            const existingResult = textPart.querySelector('.part-pronunciation-result');
            if (existingResult) {
                existingResult.remove();
            }
        }

        // ==================== MAIN PRONUNCIATION PRACTICE ====================
        let mainRecognition = null;
        let isMainRecording = false;
        let mainRecognitionGotResult = false;

        function toggleMainPronunciation() {
            if (isMainRecording) {
                stopMainRecording();
            } else {
                startMainRecording();
            }
        }

        function startMainRecording() {
            if (segments.length === 0 || currentIndex >= segments.length) {
                alert('No segment loaded for pronunciation practice.');
                return;
            }

            // Check if Speech Recognition is available
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Your browser does not support voice recognition. Try using Chrome.');
                return;
            }

            const btn = document.getElementById('mainPronunciationBtn');

            // Hide previous result
            hideMainPronunciationResult();
            mainRecognitionGotResult = false;

            mainRecognition = initSpeechRecognition();
            if (!mainRecognition) return;

            mainRecognition.onstart = () => {
                isMainRecording = true;
                btn.classList.add('recording');
                btn.textContent = ' Recording';
            };

            mainRecognition.onresult = (event) => {
                mainRecognitionGotResult = true;
                const transcript = event.results[0][0].transcript;
                const confidence = event.results[0][0].confidence;
                compareMainPronunciation(transcript, confidence);
            };

            mainRecognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                mainRecognitionGotResult = true; // Prevent duplicate error in onend
                stopMainRecording();

                if (event.error === 'no-speech') {
                    showMainPronunciationError('Could not detect your voice. Try again.');
                } else if (event.error === 'audio-capture') {
                    showMainPronunciationError('Microphone not found. Check permissions.');
                } else {
                    showMainPronunciationError('Recognition error. Try again.');
                }
            };

            mainRecognition.onend = () => {
                stopMainRecording();
                // If no result was captured, show a message
                if (!mainRecognitionGotResult) {
                    showMainPronunciationError('Could not capture your voice. Try speaking louder.');
                }
            };

            try {
                mainRecognition.start();
            } catch (e) {
                console.error('Error starting recognition:', e);
                showMainPronunciationError('Error starting recording. Try again.');
            }
        }

        function stopMainRecording() {
            isMainRecording = false;
            const btn = document.getElementById('mainPronunciationBtn');

            btn.classList.remove('recording');
            btn.textContent = ' Pronunciation';

            if (mainRecognition) {
                try {
                    mainRecognition.stop();
                } catch (e) {
                    // Ignore errors when stopping
                }
            }
        }

        function compareMainPronunciation(transcript, confidence) {
            if (segments.length === 0 || currentIndex >= segments.length) return;

            const segment = segments[currentIndex];
            const originalPhrase = segment.text.toLowerCase().trim();
            const spokenPhrase = transcript.toLowerCase().trim();

            // Calculate similarity between original and spoken
            const similarity = calculateSimilarity(spokenPhrase, originalPhrase);

            // Combine with speech recognition confidence
            const finalScore = Math.round((similarity * 0.7 + (confidence * 100) * 0.3));

            // Update statistics
            studyStats.pronunciationAttempts++;
            if (finalScore >= 90) {
                studyStats.pronunciationSuccesses++;
            }
            saveStats();
            updateStatsDisplay();

            showMainPronunciationResult(finalScore, originalPhrase, spokenPhrase);
        }

        function showMainPronunciationResult(score, original, spoken) {
            const resultDiv = document.getElementById('mainPronunciationResult');
            const scoreDiv = document.getElementById('mainPronunciationScore');
            const feedbackDiv = document.getElementById('mainPronunciationFeedback');
            const detailsDiv = document.getElementById('mainPronunciationDetails');

            scoreDiv.textContent = `${score}%`;

            // Determine feedback based on score
            resultDiv.classList.remove('excellent', 'good', 'needs-practice');

            if (score >= 90) {
                resultDiv.classList.add('excellent');
                feedbackDiv.textContent = 'Excellent! Your pronunciation is great! ';
            } else if (score >= 70) {
                resultDiv.classList.add('good');
                feedbackDiv.textContent = 'Good job! Keep practicing. ';
            } else {
                resultDiv.classList.add('needs-practice');
                feedbackDiv.textContent = 'Needs more practice. Listen again and try again! ';
            }

            detailsDiv.innerHTML = `
                <strong>You said:</strong> "${spoken}"<br>
                <strong>Original:</strong> "${original}"
            `;

            resultDiv.classList.add('active');
        }

        function showMainPronunciationError(message) {
            const resultDiv = document.getElementById('mainPronunciationResult');
            const scoreDiv = document.getElementById('mainPronunciationScore');
            const feedbackDiv = document.getElementById('mainPronunciationFeedback');
            const detailsDiv = document.getElementById('mainPronunciationDetails');

            scoreDiv.textContent = '';
            feedbackDiv.textContent = message;
            detailsDiv.textContent = '';

            resultDiv.classList.remove('excellent', 'good');
            resultDiv.classList.add('needs-practice', 'active');
        }

        function hideMainPronunciationResult() {
            const resultDiv = document.getElementById('mainPronunciationResult');
            resultDiv.classList.remove('active', 'excellent', 'good', 'needs-practice');
        }

        function prevSegment() {
            if (currentIndex > 0) {
                stopPlayback();
                hideMainPronunciationResult();
                currentIndex--;
                updateDisplay();
                updateCheckingSection();
                saveEpisodePosition();
            }
        }

        function nextSegment() {
            if (currentIndex < segments.length - 1) {
                stopPlayback();
                hideMainPronunciationResult();
                currentIndex++;
                updateDisplay();
                updateCheckingSection();
                saveEpisodePosition();
            }
        }

        // Checking Mode Functions
        let isCheckingMode = false;

        function toggleCheckingMode() {
            isCheckingMode = document.getElementById('checkingMode').checked;

            const textDisplay = document.getElementById('textDisplay');
            const checkingSection = document.getElementById('checkingSection');

            if (isCheckingMode) {
                textDisplay.classList.add('text-hidden');
                checkingSection.classList.add('active');
                // Update time range in checking section
                if (segments.length > 0) {
                    document.getElementById('timeRangeChecking').textContent = segments[currentIndex].time_range;
                }
                // Clear previous input and result
                document.getElementById('checkingInput').value = '';
                hideCheckingResult();
            } else {
                textDisplay.classList.remove('text-hidden');
                checkingSection.classList.remove('active');
            }
        }

        function checkAnswer() {
            if (segments.length === 0) return;

            const userInput = document.getElementById('checkingInput').value.trim();
            if (!userInput) {
                alert('Please type what you heard before checking.');
                return;
            }

            const correctText = segments[currentIndex].text;
            const accuracy = calculateSimilarity(userInput, correctText);

            const resultDiv = document.getElementById('checkingResult');
            const accuracyDiv = resultDiv.querySelector('.accuracy');
            const correctionText = resultDiv.querySelector('.correction-text');

            accuracyDiv.textContent = `${Math.round(accuracy)}% de precisao`;
            correctionText.textContent = correctText;

            // Remove previous classes
            resultDiv.classList.remove('success', 'fail');

            // Add appropriate class based on accuracy
            if (accuracy >= 80) {
                resultDiv.classList.add('success');
                accuracyDiv.textContent += ' - Well done!';
            } else {
                resultDiv.classList.add('fail');
                accuracyDiv.textContent += ' - Keep practicing!';
            }

            resultDiv.classList.add('active');
        }

        function hideCheckingResult() {
            const resultDiv = document.getElementById('checkingResult');
            resultDiv.classList.remove('active', 'success', 'fail');
        }

        function calculateSimilarity(str1, str2) {
            // Normalize strings: lowercase, remove punctuation, extra spaces
            const normalize = (s) => s.toLowerCase()
                .replace(/[^\w\s]/g, '')
                .replace(/\s+/g, ' ')
                .trim();

            const s1 = normalize(str1);
            const s2 = normalize(str2);

            if (s1 === s2) return 100;
            if (s1.length === 0 || s2.length === 0) return 0;

            // Use Levenshtein distance for similarity
            const matrix = [];

            for (let i = 0; i <= s1.length; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= s2.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= s1.length; i++) {
                for (let j = 1; j <= s2.length; j++) {
                    if (s1[i - 1] === s2[j - 1]) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1, // substitution
                            matrix[i][j - 1] + 1,     // insertion
                            matrix[i - 1][j] + 1      // deletion
                        );
                    }
                }
            }

            const distance = matrix[s1.length][s2.length];
            const maxLength = Math.max(s1.length, s2.length);
            const similarity = ((maxLength - distance) / maxLength) * 100;

            return Math.max(0, similarity);
        }

        // Update checking section when segment changes
        function updateCheckingSection() {
            if (isCheckingMode && segments.length > 0) {
                document.getElementById('timeRangeChecking').textContent = segments[currentIndex].time_range;
                document.getElementById('checkingInput').value = '';
                hideCheckingResult();
            }
        }

        // Keyboard shortcuts are handled by handleKeydown function below
        // (see ENHANCED KEYBOARD SHORTCUTS section)

        // ==================== PHONETIC PRONUNCIATION (PT-BR) ====================
        // Converts English text to approximate Brazilian Portuguese phonetic pronunciation
        function toPortuguesePhonetic(text) {
            if (!text) return '';

            let result = text.toLowerCase();

            // Common English words with specific pronunciations
            const wordMap = {
                // Common words
                'hello': 'rlou',
                'hi': 'ri',
                'hey': 'ri',
                'bye': 'bi',
                'goodbye': 'gudbi',
                'yes': 'is',
                'no': 'nu',
                'ok': 'oki',
                'okay': 'oki',
                'please': 'pliz',
                'thank': 'fnk',
                'thanks': 'fnks',
                'you': 'i',
                'your': 'ir',
                "you're": 'ir',
                'the': 'd',
                'this': 'ds',
                'that': 'dt',
                'what': 'ut',
                'where': 'ur',
                'when': 'un',
                'why': 'ui',
                'who': 'r',
                'how': 'ru',
                'i': 'i',
                "i'm": 'im',
                "i've": 'iv',
                "i'll": 'il',
                'my': 'mi',
                'me': 'm',
                'we': 'u',
                "we're": 'ur',
                'they': 'di',
                "they're": 'dr',
                'their': 'dr',
                'there': 'dr',
                'he': 'r',
                "he's": 'rz',
                'she': 'x',
                "she's": 'xz',
                'it': 't',
                "it's": 'ts',
                'is': 'z',
                'are': 'r',
                'was': 'uz',
                'were': 'ur',
                'be': 'b',
                'been': 'bn',
                'being': 'bin',
                'have': 'rv',
                'has': 'rz',
                'had': 'rd',
                'do': 'd',
                'does': 'dz',
                'did': 'dd',
                "don't": 'dunt',
                "doesn't": 'dznt',
                "didn't": 'ddnt',
                'can': 'kn',
                "can't": 'knt',
                'could': 'kd',
                "couldn't": 'kdnt',
                'would': 'ud',
                "wouldn't": 'udnt',
                'should': 'xd',
                "shouldn't": 'xdnt',
                'will': 'ul',
                "won't": 'uunt',
                'want': 'unt',
                'need': 'nid',
                'like': 'lik',
                'love': 'lv',
                'know': 'nu',
                'think': 'fnk',
                'say': 'si',
                'said': 'sd',
                'get': 'gut',
                'got': 'gt',
                'go': 'gu',
                'going': 'guin',
                'gone': 'gn',
                'come': 'km',
                'coming': 'kmin',
                'see': 's',
                'look': 'lk',
                'make': 'mik',
                'take': 'tik',
                'give': 'guv',
                'tell': 'tl',
                'work': 'urk',
                'call': 'kl',
                'try': 'tri',
                'ask': 'sk',
                'feel': 'fil',
                'become': 'bikm',
                'leave': 'liv',
                'put': 'pt',
                'mean': 'min',
                'keep': 'kip',
                'let': 'lt',
                'begin': 'bigun',
                'seem': 'sim',
                'help': 'rlp',
                'show': 'xu',
                'hear': 'rar',
                'play': 'pli',
                'run': 'rn',
                'move': 'muv',
                'live': 'lv',
                'believe': 'biliv',
                'hold': 'ruld',
                'bring': 'brng',
                'write': 'rit',
                'read': 'rid',
                'learn': 'lrn',
                'change': 'tchindj',
                'follow': 'flou',
                'stop': 'stp',
                'start': 'strt',
                'watch': 'utch',
                'speak': 'spik',
                'turn': 'trn',
                'buy': 'bi',
                'pay': 'pi',
                'meet': 'mit',
                'sit': 'st',
                'stand': 'stnd',
                'lose': 'luz',
                'win': 'un',
                'wait': 'uit',
                'send': 'snd',
                'build': 'bld',
                'stay': 'sti',
                'fall': 'fl',
                'cut': 'kt',
                'reach': 'ritch',
                'kill': 'kl',
                'raise': 'riz',
                'spend': 'spnd',
                'grow': 'gru',
                'open': 'upen',
                'walk': 'uk',
                'offer': 'fer',
                'remember': 'rimmbr',
                'consider': 'konsdr',
                'appear': 'apar',
                'buy': 'bi',
                'wait': 'uit',
                'serve': 'srv',
                'die': 'di',
                'expect': 'ekspkt',
                'stay': 'sti',
                'agree': 'agr',
                'actually': 'ktxuali',
                'really': 'rali',
                'always': 'lueiz',
                'never': 'nvr',
                'sometimes': 'smtimz',
                'often': 'fen',
                'usually': 'ijuali',
                'maybe': 'mibi',
                'probably': 'prbabli',
                'just': 'djst',
                'very': 'vri',
                'much': 'mtch',
                'more': 'mr',
                'most': 'must',
                'other': 'dr',
                'some': 'sm',
                'any': 'ni',
                'all': 'l',
                'each': 'itch',
                'every': 'vri',
                'both': 'buf',
                'few': 'fi',
                'many': 'mni',
                'which': 'utch',
                'such': 'stch',
                'after': 'ftr',
                'before': 'bifr',
                'between': 'bituin',
                'under': 'ndr',
                'again': 'aguin',
                'still': 'stl',
                'also': 'lsou',
                'back': 'bk',
                'now': 'nu',
                'even': 'ven',
                'new': 'ni',
                'because': 'bikz',
                'about': 'abut',
                'into': 'ntu',
                'through': 'fru',
                'during': 'dirin',
                'without': 'uidut',
                'world': 'urld',
                'people': 'ppol',
                'life': 'lif',
                'day': 'di',
                'way': 'ui',
                'thing': 'fng',
                'man': 'mn',
                'woman': 'uman',
                'child': 'tchild',
                'time': 'tim',
                'year': 'ar',
                'right': 'rit',
                'good': 'gd',
                'great': 'grit',
                'little': 'ltol',
                'long': 'lng',
                'own': 'un',
                'old': 'uld',
                'big': 'bg',
                'high': 'ri',
                'different': 'dferent',
                'small': 'sml',
                'large': 'lrdj',
                'next': 'nkst',
                'early': 'rli',
                'young': 'ing',
                'important': 'imprtant',
                'public': 'pblik',
                'bad': 'bd',
                'same': 'sim',
                'able': 'ibol',
                'first': 'frst',
                'last': 'lst',
                'sure': 'xr',
                'true': 'tr',
                'better': 'btr',
                'best': 'bst',
                'right': 'rit',
                'left': 'lft',
                'here': 'rar',
                'together': 'tugudr',
                'only': 'nli',
                'something': 'smfing',
                'nothing': 'nfing',
                'everything': 'vrifing',
                'anything': 'nifing',
                'someone': 'smun',
                'everyone': 'vriun',
                'anyone': 'niun',
                'english': 'nglish',
                'american': 'amrikn',
                'today': 'tudi',
                'night': 'nit',
                'morning': 'mrnin',
                'afternoon': 'ftrnun',
                'evening': 'vnin',
                'week': 'uik',
                'month': 'mnf',
                'water': 'utr',
                'food': 'fud',
                'house': 'rus',
                'home': 'rum',
                'school': 'skul',
                'money': 'mni',
                'friend': 'frnd',
                'family': 'fmili',
                'book': 'bk',
                'question': 'kustchn',
                'business': 'bzns',
                'study': 'stdi',
                'problem': 'prblm',
                'music': 'mizik',
                'movie': 'muvi',
                'game': 'guim',
                'idea': 'aida',
                'information': 'informixn',
                'power': 'pur',
                'country': 'kntri',
                'place': 'plis',
                'city': 'sti',
                'company': 'kmpani',
                'story': 'stri',
                'fact': 'fkt',
                'group': 'grup',
                'number': 'nmbr',
                'night': 'nit',
                'point': 'pint',
                'part': 'prt',
                'place': 'plis',
                'case': 'kis',
                'week': 'uik',
                'example': 'iguizmpol',
                'system': 'sstm',
                'program': 'prugrm',
                'question': 'kustchn',
                'government': 'gvrnmnt',
                'against': 'agunst',
                'above': 'abv',
                'below': 'bilu',
                'must': 'mst',
                'might': 'mit',
                'shall': 'xl',
                'already': 'olrdi',
                'enough': 'inf',
                'though': 'du',
                'although': 'oldu',
                'whether': 'udr',
                'either': 'idr',
                'neither': 'nidr',
                'while': 'uil',
                'until': 'ntl',
                'since': 'sns',
                'however': 'rauvr',
                'therefore': 'drfr',
                'within': 'uidn',
                'yourself': 'iorslf',
                'myself': 'maislf',
                'himself': 'rimslf',
                'herself': 'rrslf',
                'itself': 'itislf',
                'themselves': 'dmslvs',
                'ourselves': 'aurslvs',
                // Words where "ea" sounds like "" (not "")
                'head': 'rd',
                'dead': 'dd',
                'bread': 'brd',
                'thread': 'frd',
                'spread': 'sprd',
                'instead': 'instd',
                'ahead': 'ard',
                'already': 'olrdi',
                'ready': 'rdi',
                'steady': 'stdi',
                'heavy': 'rvi',
                'heaven': 'rven',
                'weapon': 'upon',
                'weather': 'udr',
                'leather': 'ldr',
                'feather': 'fdr',
                'health': 'rlf',
                'healthy': 'rlfi',
                'wealth': 'ulf',
                'wealthy': 'ulfi',
                'breath': 'brf',
                'death': 'df',
                'sweat': 'sut',
                'sweater': 'sutr',
                'breakfast': 'brkfst',
                'meant': 'mnt',
                'dealt': 'dlt',
                'dreamt': 'drmt',
                'leapt': 'lpt',
                'jealous': 'djls',
                'pleasant': 'plznt',
                'pleasure': 'pljr',
                'measure': 'mjr',
                'treasure': 'trjr',
                'great': 'grit',
                'break': 'brik',
                'steak': 'stik',
                // Words with "ough" = "" sound
                'thought': 'ft',
                'thoughts': 'fts',
                'bought': 'bt',
                'brought': 'brt',
                'fought': 'ft',
                'sought': 'st',
                'ought': 't',
                'caught': 'kt',
                'taught': 'tt',
                'daughter': 'dtr',
                // Words with "ough" = "u" sound
                'though': 'du',
                'although': 'oldu',
                'dough': 'du',
                // Words with "ough" = "f" sound
                'enough': 'inf',
                'tough': 'tf',
                'rough': 'rf',
                // Words with "ough" = "" sound
                'through': 'fru',
                // Words with "ough" = "u" sound
                'drought': 'drut',
                // Other commonly mispronounced words
                'could': 'kd',
                'would': 'ud',
                'should': 'xd',
                'walk': 'uk',
                'talk': 'tk',
                'half': 'rf',
                'calf': 'kf',
                'calm': 'km',
                'palm': 'pm',
                'salmon': 'smon',
                'listen': 'lsen',
                'often': 'fen',
                'castle': 'ksol',
                'island': 'ilnd',
                'answer': 'nsr',
                'sword': 'srd',
                'two': 't',
                'who': 'r',
                'whole': 'rul',
                'whose': 'rz',
                'write': 'rit',
                'wrong': 'rng',
                'know': 'nu',
                'knew': 'ni',
                'known': 'nun',
                'knife': 'nif',
                'knee': 'n',
                'knight': 'nit',
                'knock': 'nk',
                // "oo" short sound (not "u" but "u")
                'good': 'gud',
                'book': 'buk',
                'look': 'luk',
                'cook': 'kuk',
                'took': 'tuk',
                'hook': 'ruk',
                'foot': 'fut',
                'wood': 'uud',
                'stood': 'stud',
                'would': 'uud',
                'could': 'kud',
                'should': 'xud',
                'put': 'put',
                'push': 'pux',
                'pull': 'pul',
                'full': 'ful',
                'bull': 'bul',
                // "ou" = "" sound
                'touch': 'ttch',
                'young': 'ing',
                'country': 'kntri',
                'trouble': 'trbol',
                'double': 'dbol',
                'couple': 'kpol',
                'cousin': 'kzin',
                'enough': 'inf',
                'rough': 'rf',
                'tough': 'tf',
                'southern': 'sdrn',
                // "ou" = "u" sound
                'soul': 'sul',
                'shoulder': 'xuldr',
                'poultry': 'pultri',
                // "ow" = "u" (not "u")
                'know': 'nu',
                'show': 'xu',
                'grow': 'gru',
                'throw': 'fru',
                'flow': 'flu',
                'slow': 'slu',
                'low': 'lu',
                'blow': 'blu',
                'snow': 'snu',
                'follow': 'flu',
                'window': 'undu',
                'yellow': 'ilu',
                'tomorrow': 'tumru',
                'borrow': 'bru',
                'arrow': 'ru',
                'narrow': 'nru',
                'own': 'un',
                'shown': 'xun',
                'grown': 'grun',
                'thrown': 'frun',
                'known': 'nun',
                'bowl': 'bul',
                // "ow" = "u" (correct as-is in rules)
                'now': 'nu',
                'how': 'ru',
                'cow': 'ku',
                'town': 'tun',
                'down': 'dun',
                'brown': 'brun',
                'crown': 'krun',
                'frown': 'frun',
                'power': 'pur',
                'tower': 'tur',
                'flower': 'flur',
                'shower': 'xur',
                'allow': 'alu',
                // Silent letters - "mb"
                'climb': 'klim',
                'comb': 'kum',
                'lamb': 'lm',
                'thumb': 'fm',
                'bomb': 'bm',
                'dumb': 'dm',
                'numb': 'nm',
                'limb': 'lm',
                'tomb': 'tum',
                'womb': 'um',
                // Silent letters - "bt"
                'debt': 'dt',
                'doubt': 'dut',
                'subtle': 'stol',
                // Silent letters - "gn"
                'sign': 'sin',
                'design': 'dizin',
                'resign': 'rizin',
                'foreign': 'frin',
                'reign': 'rin',
                'campaign': 'kampin',
                // Silent letters - "ps", "pn"
                'psychology': 'saiklodji',
                'psalm': 'sm',
                'pseudo': 'sudou',
                'pneumonia': 'niumunia',
                // Silent letters - "mn"
                'autumn': 'tm',
                'column': 'klm',
                'hymn': 'rm',
                'solemn': 'slm',
                // "ch" = "k" sound
                'character': 'krktr',
                'chemistry': 'kmistri',
                'chorus': 'krs',
                'chrome': 'krum',
                'chronic': 'krnik',
                'chaos': 'kis',
                'ache': 'ik',
                'stomach': 'stmk',
                'anchor': 'nkr',
                'echo': 'ku',
                'school': 'skul',
                'scheme': 'skim',
                'mechanic': 'meknik',
                'technology': 'teknlodji',
                'architect': 'rkitekt',
                'orchestra': 'rkestra',
                // "ch" = "x" (sh sound)
                'machine': 'maxin',
                'chef': 'xf',
                'champagne': 'xampin',
                'chic': 'xk',
                'brochure': 'broxr',
                'parachute': 'praxut',
                'mustache': 'mstx',
                // "igh" words (long i sound)
                'light': 'lit',
                'night': 'nit',
                'right': 'rit',
                'sight': 'sit',
                'fight': 'fit',
                'might': 'mit',
                'tight': 'tit',
                'flight': 'flit',
                'bright': 'brit',
                'slight': 'slit',
                'high': 'ri',
                'thigh': 'fi',
                'sigh': 'si',
                // Common irregular words
                'one': 'un',
                'once': 'uns',
                'done': 'dn',
                'none': 'nn',
                'gone': 'gn',
                'son': 'sn',
                'won': 'un',
                'ton': 'tn',
                'front': 'frnt',
                'month': 'mnf',
                'money': 'mni',
                'honey': 'rni',
                'monkey': 'mnki',
                'tongue': 'tng',
                'among': 'amng',
                'blood': 'bld',
                'flood': 'fld',
                'does': 'dz',
                'shoe': 'x',
                'move': 'muv',
                'prove': 'pruv',
                'lose': 'luz',
                'whose': 'ruz',
                'women': 'umin',
                'woman': 'umn',
                'busy': 'bzi',
                'business': 'bznes',
                'build': 'bld',
                'built': 'blt',
                'buy': 'bi',
                'guy': 'gi',
                'guide': 'gid',
                'guitar': 'guitr',
                'guest': 'gust',
                'guess': 'guss',
                'guard': 'grd',
                'guarantee': 'granti',
                // Action verbs and adjectives
                'wake': 'uik',
                'woke': 'uuk',
                'awake': 'auik',
                'achieve': 'atchv',
                'achieved': 'atchvd',
                'achieves': 'atchvs',
                'achievement': 'atchvmnt',
                'empower': 'empuer',
                'empowers': 'empuers',
                'empowered': 'empuerd',
                'power': 'puer',
                'powerful': 'puerfl',
                'potential': 'potnchl',
                'big': 'bg',
                'bigger': 'bguer',
                'biggest': 'bguest',
                // Words with "wor-" (sounds like "wr")
                'work': 'urk',
                'word': 'urd',
                'world': 'urld',
                'worth': 'urf',
                'worse': 'urs',
                'worst': 'urst',
                'worry': 'uri',
                'worm': 'urm',
                // Words with "war-" (sounds like "wr")
                'war': 'ur',
                'warm': 'urm',
                'warn': 'urn',
                'warning': 'urnin',
                // Common verbs - past tense
                'said': 'sd',
                'paid': 'pid',
                'laid': 'lid',
                'made': 'mid',
                'came': 'kim',
                'became': 'bikim',
                'gave': 'guiv',
                'took': 'tk',
                'went': 'unt',
                'sent': 'snt',
                'spent': 'spnt',
                'left': 'lft',
                'kept': 'kpt',
                'slept': 'slpt',
                'felt': 'flt',
                'held': 'rld',
                'told': 'tuld',
                'sold': 'suld',
                'found': 'fund',
                'ground': 'grund',
                'round': 'rund',
                'sound': 'sund',
                'bound': 'bund',
                // Question words
                'what': 'ut',
                'where': 'ur',
                'when': 'un',
                'which': 'utch',
                'why': 'ui',
                'who': 'r',
                'whom': 'rum',
                'whose': 'ruz',
                'how': 'ru',
                // Prepositions and conjunctions
                'to': 't',
                'too': 't',
                'into': 'ntu',
                'onto': 'ntu',
                'of': 'v',
                'off': 'f',
                'from': 'frm',
                'for': 'fr',
                'with': 'uf',
                'without': 'uidut',
                'within': 'uidn',
                'but': 'bt',
                'or': 'r',
                'and': 'nd',
                'if': 'f',
                'then': 'dn',
                'than': 'dn',
                'because': 'bikz',
                'although': 'oldu',
                'though': 'du',
                'through': 'fr',
                'throughout': 'fruut',
                // Words with "oa" (long O sound)
                'goal': 'gul',
                'goals': 'guls',
                'road': 'rud',
                'roads': 'ruds',
                'boat': 'but',
                'boats': 'buts',
                'coat': 'cut',
                'coats': 'cuts',
                'toast': 'tust',
                'roast': 'rust',
                'coast': 'cust',
                'load': 'lud',
                'loads': 'luds',
                'soap': 'sup',
                'foam': 'fum',
                'loan': 'lun',
                'loans': 'luns',
                'moan': 'mun',
                'groan': 'grun',
                'oak': 'uk',
                'soak': 'suk',
                'cloak': 'cluk',
                'coach': 'cutch',
                'approach': 'aprutch',
                'roach': 'rutch',
                // Brand names and compound words
                'squarespace': 'skurspis',
                'website': 'ubsait',
                'facebook': 'fisbuk',
                'youtube': 'itb',
                'instagram': 'nstagram',
                'twitter': 'tutr',
                'linkedin': 'lnkidn',
                'podcast': 'pdkst',
                'podcasts': 'pdksts',
                // Soft G (sounds like "dj") - G before E, I
                'george': 'djrdj',
                'georgie': 'djrji',
                'georgia': 'djrdjia',
                'giant': 'djiant',
                'ginger': 'djndjr',
                'general': 'djneral',
                'generally': 'djnerali',
                'generate': 'djnerit',
                'generation': 'djenerixn',
                'generous': 'djners',
                'genius': 'djnis',
                'gentle': 'djntol',
                'gently': 'djntli',
                'genuine': 'djniun',
                'gesture': 'djstchr',
                'gel': 'djl',
                'gem': 'djm',
                'gene': 'djin',
                'genes': 'djins',
                'genetic': 'djentik',
                'gym': 'djm',
                'gist': 'djst',
                'giraffe': 'djirf',
                'gymnast': 'djmnest',
                'gymnastics': 'djimnstiks',
                'gyro': 'djiro',
                'gypsy': 'djpsi',
                'page': 'pidj',
                'pages': 'pidjes',
                'age': 'idj',
                'ages': 'idjes',
                'stage': 'stidj',
                'stages': 'stidjes',
                'image': 'midj',
                'images': 'midjes',
                'manage': 'mnidj',
                'manages': 'mnidjes',
                'manager': 'mnidjr',
                'message': 'msidj',
                'messages': 'msidjes',
                'package': 'pkidj',
                'packages': 'pkidjes',
                'damage': 'dmidj',
                'average': 'veridj',
                'village': 'vlidj',
                'college': 'klidj',
                'knowledge': 'nlidj',
                'edge': 'dj',
                'bridge': 'brdj',
                'judge': 'djdj',
                'huge': 'hidj',
                'change': 'tchindj',
                'changes': 'tchindjes',
                'changed': 'tchindjd',
                'changing': 'tchindjin',
                'strange': 'strindj',
                'stranger': 'strindjr',
                'range': 'rindj',
                'orange': 'rindj',
                'arrange': 'arindj',
                'challenge': 'tchllindj',
                'exchange': 'ikstchindj',
                'engine': 'ndjin',
                'engineer': 'endjinr',
                'imagine': 'imdjen',
                'region': 'rdjn',
                'religion': 'rildjn',
                'original': 'ordjenol',
                'magic': 'mdjik',
                'magical': 'mdjikol',
                'tragic': 'trdjik',
                'logic': 'ldjik',
                'energy': 'nerdji',
                'emergency': 'imrdjnsi',
                'strategy': 'strtedji',
                'technology': 'teknlodji',
                'psychology': 'saiklodji',
                'biology': 'bailodji',
                'apology': 'aplodji',
                'allergy': 'llerdji',
                // Common animals
                'cat': 'kt',
                'cats': 'kts',
                'dog': 'dg',
                'dogs': 'dgz',
                'bird': 'brd',
                'birds': 'brdz',
                'fish': 'fx',
                'horse': 'rrs',
                'horses': 'rrsez',
                'cow': 'ku',
                'cows': 'kuz',
                'pig': 'pg',
                'pigs': 'pgz',
                'chicken': 'tchken',
                'rabbit': 'rbit',
                'mouse': 'mus',
                'mice': 'mis',
                'lion': 'lin',
                'tiger': 'tigr',
                'bear': 'br',
                'wolf': 'ulf',
                'fox': 'fks',
                'deer': 'dr',
                'elephant': 'lifnt',
                'monkey': 'mnki',
                'snake': 'snik',
                'spider': 'spidr',
                'ant': 'nt',
                'bee': 'bi',
                'butterfly': 'btrfli',
                // Join/Joining and related words
                'join': 'djin',
                'joins': 'djins',
                'joined': 'djind',
                'joining': 'djinin',
                'enjoy': 'endji',
                'enjoys': 'endjis',
                'enjoyed': 'endjid',
                'enjoying': 'endjiin',
                'enjoyment': 'endjimnt',
                // Again and related words
                'again': 'agun',
                'against': 'agunst',
                // Common everyday words that often have errors
                'me': 'm',
                'my': 'mi',
                'mine': 'min',
                'myself': 'maisuf',
                'you': 'i',
                'your': 'ir',
                'yours': 'irs',
                'yourself': 'iorsuf',
                'he': 'r',
                'his': 'rz',
                'him': 'rm',
                'himself': 'rimsuf',
                'she': 'x',
                'her': 'rr',
                'hers': 'rrs',
                'herself': 'rrsuf',
                'it': 't',
                'its': 'ts',
                'itself': 'itsuf',
                'we': 'u',
                'us': 's',
                'our': 'ur',
                'ours': 'urs',
                'ourselves': 'aursuvs',
                'they': 'di',
                'them': 'dm',
                'their': 'dr',
                'theirs': 'drs',
                'themselves': 'demsuvs',
                // Common verbs
                'is': 'z',
                'am': 'm',
                'are': 'r',
                'was': 'uz',
                'were': 'ur',
                'be': 'b',
                'been': 'bn',
                'being': 'bin',
                'have': 'rv',
                'has': 'rz',
                'had': 'rd',
                'having': 'rvin',
                'do': 'd',
                'did': 'dd',
                'doing': 'din',
                'done': 'dn',
                'go': 'gu',
                'goes': 'guz',
                'going': 'guin',
                'get': 'gut',
                'gets': 'guts',
                'got': 'gt',
                'getting': 'gutin',
                'come': 'km',
                'comes': 'kmz',
                'coming': 'kmin',
                'see': 's',
                'sees': 'sz',
                'saw': 's',
                'seen': 'sn',
                'seeing': 'sin',
                'know': 'nu',
                'knows': 'nuz',
                'knew': 'ni',
                'known': 'nun',
                'knowing': 'nuin',
                'think': 'fnk',
                'thinks': 'fnks',
                'thought': 'ft',
                'thinking': 'fnkin',
                'want': 'unt',
                'wants': 'unts',
                'wanted': 'untid',
                'wanting': 'untin',
                'need': 'nid',
                'needs': 'nids',
                'needed': 'nidid',
                'needing': 'nidin',
                'like': 'lik',
                'likes': 'liks',
                'liked': 'likt',
                'liking': 'likin',
                'love': 'lv',
                'loves': 'lvz',
                'loved': 'lvd',
                'loving': 'lvin',
                'say': 'si',
                'says': 'sz',
                'saying': 'siin',
                'tell': 'tl',
                'tells': 'tlz',
                'telling': 'tlin',
                'talk': 'tk',
                'talks': 'tks',
                'talked': 'tkt',
                'talking': 'tkin',
                'speak': 'spik',
                'speaks': 'spiks',
                'spoke': 'spuk',
                'spoken': 'spukn',
                'speaking': 'spikin',
                'listen': 'lsn',
                'listens': 'lsnz',
                'listened': 'lsnd',
                'listening': 'lstnin',
                'hear': 'rr',
                'hears': 'rrs',
                'heard': 'rrd',
                'hearing': 'rrin',
                'look': 'lk',
                'looks': 'lks',
                'looked': 'lkt',
                'looking': 'lkin',
                'watch': 'utch',
                'watches': 'utches',
                'watched': 'utcht',
                'watching': 'utchin',
                'read': 'rid',
                'reads': 'rids',
                'reading': 'ridin',
                'write': 'rit',
                'writes': 'rits',
                'wrote': 'rut',
                'written': 'rtn',
                'writing': 'ritin',
                'learn': 'lrn',
                'learns': 'lrnz',
                'learned': 'lrnd',
                'learning': 'lrnin',
                'teach': 'ttch',
                'teaches': 'ttches',
                'taught': 'tt',
                'teaching': 'ttchin',
                'try': 'tri',
                'tries': 'triz',
                'tried': 'trid',
                'trying': 'triin',
                'help': 'rlp',
                'helps': 'rlps',
                'helped': 'rlpt',
                'helping': 'rlpin',
                'start': 'strt',
                'starts': 'strts',
                'started': 'strtid',
                'starting': 'strtin',
                'stop': 'stp',
                'stops': 'stps',
                'stopped': 'stpt',
                'stopping': 'stpin',
                'wait': 'uit',
                'waits': 'uits',
                'waited': 'uitid',
                'waiting': 'uitin',
                'call': 'kl',
                'calls': 'klz',
                'called': 'kld',
                'calling': 'klin',
                'ask': 'sk',
                'asks': 'sks',
                'asked': 'skt',
                'asking': 'skin',
                'answer': 'nser',
                'answers': 'nsers',
                'answered': 'nserd',
                'answering': 'nserin',
                'play': 'pli',
                'plays': 'pliz',
                'played': 'plid',
                'playing': 'pliin',
                'work': 'urk',
                'works': 'urks',
                'worked': 'urkt',
                'working': 'urkin',
                'live': 'lv',
                'lives': 'lvz',
                'lived': 'lvd',
                'living': 'lvin',
                'run': 'rn',
                'runs': 'rnz',
                'ran': 'rn',
                'running': 'rnin',
                'walk': 'uk',
                'walks': 'uks',
                'walked': 'ukt',
                'walking': 'ukin',
                'sit': 'st',
                'sits': 'sts',
                'sat': 'st',
                'sitting': 'stin',
                'stand': 'stnd',
                'stands': 'stnds',
                'stood': 'std',
                'standing': 'stndin',
                'sleep': 'slip',
                'sleeps': 'slips',
                'sleeping': 'slipin',
                'eat': 'it',
                'eats': 'its',
                'ate': 'it',
                'eaten': 'itn',
                'eating': 'itin',
                'drink': 'drnk',
                'drinks': 'drnks',
                'drank': 'drnk',
                'drunk': 'drnk',
                'drinking': 'drnkin',
                'give': 'guv',
                'gives': 'guvz',
                'gave': 'guiv',
                'given': 'guvn',
                'giving': 'guvin',
                'take': 'tik',
                'takes': 'tiks',
                'took': 'tk',
                'taken': 'tikn',
                'taking': 'tikin',
                'put': 'pt',
                'puts': 'pts',
                'putting': 'ptin',
                'bring': 'brng',
                'brings': 'brngz',
                'brought': 'brt',
                'bringing': 'brngin',
                'keep': 'kip',
                'keeps': 'kips',
                'keeping': 'kipin',
                'let': 'lt',
                'lets': 'lts',
                'letting': 'ltin',
                'begin': 'bigun',
                'begins': 'biguns',
                'began': 'bigun',
                'begun': 'bign',
                'beginning': 'bigunin',
                'end': 'nd',
                'ends': 'ndz',
                'ended': 'ndid',
                'ending': 'ndin',
                'finish': 'fnix',
                'finishes': 'fnixes',
                'finished': 'fnixt',
                'finishing': 'fnixin',
                'continue': 'kontniu',
                'continues': 'kontniuz',
                'continued': 'kontniud',
                'continuing': 'kontniuin',
                'follow': 'flu',
                'follows': 'fluz',
                'followed': 'flud',
                'following': 'fluin',
                'lead': 'lid',
                'leads': 'lids',
                'led': 'ld',
                'leading': 'lidin',
                'show': 'xu',
                'shows': 'xuz',
                'showed': 'xud',
                'shown': 'xun',
                'showing': 'xuin',
                'feel': 'fil',
                'feels': 'filz',
                'feeling': 'filin',
                'seem': 'sim',
                'seems': 'simz',
                'seemed': 'smd',
                'seeming': 'simin',
                'become': 'bikm',
                'becomes': 'bikmz',
                'becoming': 'bikmin',
                'happen': 'rpn',
                'happens': 'rpnz',
                'happened': 'rpnd',
                'happening': 'rpnin',
                'matter': 'mtr',
                'matters': 'mtrz',
                'mattered': 'mtrd',
                'mean': 'min',
                'means': 'minz',
                'meant': 'mnt',
                'meaning': 'minin',
                'remember': 'rimmbr',
                'remembers': 'rimmbrz',
                'remembered': 'rimmbrd',
                'remembering': 'rimmbrin',
                'forget': 'forgut',
                'forgets': 'forguts',
                'forgot': 'forgt',
                'forgotten': 'forgtn',
                'forgetting': 'forgutin',
                'understand': 'nderstnd',
                'understands': 'nderstnds',
                'understood': 'nderstd',
                'understanding': 'nderstndin',
                'believe': 'biliv',
                'believes': 'bilivz',
                'believed': 'bilivd',
                'believing': 'bilivin',
                'expect': 'ikspkt',
                'expects': 'ikspkts',
                'expected': 'ikspktid',
                'expecting': 'ikspktin',
                'decide': 'disid',
                'decides': 'disidz',
                'decided': 'disidid',
                'deciding': 'disidin',
                'choose': 'tchuz',
                'chooses': 'tchuzez',
                'chose': 'tchuz',
                'chosen': 'tchuzn',
                'choosing': 'tchuzin',
                'create': 'kriit',
                'creates': 'kriits',
                'created': 'kriitid',
                'creating': 'kriitin',
                'build': 'bld',
                'builds': 'bldz',
                'building': 'bldin',
                'open': 'upn',
                'opens': 'upnz',
                'opened': 'upnd',
                'opening': 'upnin',
                'close': 'cluz',
                'closes': 'cluzez',
                'closed': 'cluzd',
                'closing': 'cluzin',
                'turn': 'trn',
                'turns': 'trnz',
                'turned': 'trnd',
                'turning': 'trnin',
                'move': 'muv',
                'moves': 'muvz',
                'moved': 'muvd',
                'moving': 'muvin',
                'leave': 'liv',
                'leaves': 'livz',
                'leaving': 'livin',
                'stay': 'sti',
                'stays': 'stiz',
                'stayed': 'stid',
                'staying': 'stiin',
                'spend': 'spnd',
                'spends': 'spndz',
                'spending': 'spndin',
                'pay': 'pi',
                'pays': 'piz',
                'paying': 'piin',
                'buy': 'bi',
                'buys': 'biz',
                'bought': 'bt',
                'buying': 'biin',
                'sell': 'sl',
                'sells': 'slz',
                'selling': 'slin',
                'send': 'snd',
                'sends': 'sndz',
                'sending': 'sndin',
                'receive': 'risiv',
                'receives': 'risivz',
                'received': 'risivd',
                'receiving': 'risvin',
                'meet': 'mit',
                'meets': 'mits',
                'met': 'mt',
                'meeting': 'mitin',
                'find': 'find',
                'finds': 'findz',
                'finding': 'findin',
                'lose': 'luz',
                'loses': 'luzez',
                'lost': 'lst',
                'losing': 'luzin',
                'win': 'un',
                'wins': 'unz',
                'winning': 'unin',
                'hit': 'rt',
                'hits': 'rts',
                'hitting': 'rtin',
                'cut': 'kt',
                'cuts': 'kts',
                'cutting': 'ktin',
                'set': 'st',
                'sets': 'sts',
                'setting': 'stin',
                'hold': 'ruld',
                'holds': 'ruldz',
                'holding': 'ruldin',
                'carry': 'kri',
                'carries': 'kriz',
                'carried': 'krid',
                'carrying': 'kriin',
                'pull': 'pl',
                'pulls': 'plz',
                'pulled': 'pld',
                'pulling': 'plin',
                'push': 'px',
                'pushes': 'pxes',
                'pushed': 'pxt',
                'pushing': 'pxin',
                'pick': 'pk',
                'picks': 'pks',
                'picked': 'pkt',
                'picking': 'pkin',
                'drop': 'drp',
                'drops': 'drpz',
                'dropped': 'drpt',
                'dropping': 'drpin',
                'throw': 'fru',
                'throws': 'fruz',
                'threw': 'fr',
                'thrown': 'frun',
                'throwing': 'fruin',
                'catch': 'ktch',
                'catches': 'ktches',
                'caught': 'kt',
                'catching': 'ktchin',
                'fall': 'fl',
                'falls': 'flz',
                'fell': 'fl',
                'fallen': 'fln',
                'falling': 'flin',
                'rise': 'riz',
                'rises': 'rizez',
                'rose': 'ruz',
                'risen': 'rzn',
                'rising': 'rizin',
                'grow': 'gru',
                'grows': 'gruz',
                'grew': 'gr',
                'grown': 'grun',
                'growing': 'gruin',
                'break': 'brik',
                'breaks': 'briks',
                'broke': 'bruk',
                'broken': 'brukn',
                'breaking': 'brikin',
                'fix': 'fks',
                'fixes': 'fkses',
                'fixed': 'fkst',
                'fixing': 'fksin',
                'check': 'tchk',
                'checks': 'tchks',
                'checked': 'tchkt',
                'checking': 'tchkin',
                'change': 'tchindj',
                'add': 'd',
                'adds': 'dz',
                'added': 'did',
                'adding': 'din',
                'remove': 'rimuv',
                'removes': 'rimuvz',
                'removed': 'rimuvd',
                'removing': 'rimuvin',
                'save': 'siv',
                'saves': 'sivz',
                'saved': 'sivd',
                'saving': 'sivin',
                'copy': 'kpi',
                'copies': 'kpiz',
                'copied': 'kpid',
                'copying': 'kpiin',
                'share': 'xr',
                'shares': 'xrz',
                'shared': 'xrd',
                'sharing': 'xrin',
                'connect': 'konkt',
                'connects': 'konkts',
                'connected': 'konktid',
                'connecting': 'konktin',
                'download': 'dunlud',
                'downloads': 'dunludz',
                'downloaded': 'dunludid',
                'downloading': 'dunludin',
                'upload': 'plud',
                'uploads': 'pludz',
                'uploaded': 'pludid',
                'uploading': 'pludin',
                'click': 'klk',
                'clicks': 'klks',
                'clicked': 'klkt',
                'clicking': 'klkin',
                // Time-related words
                'today': 'tudi',
                'tomorrow': 'tumrou',
                'yesterday': 'isterdi',
                'now': 'nu',
                'later': 'litr',
                'soon': 'sun',
                'already': 'olrdi',
                'still': 'stl',
                'yet': 'it',
                'always': 'luiz',
                'never': 'nvr',
                'sometimes': 'smtims',
                'often': 'fn',
                'usually': 'ijuali',
                'ever': 'vr',
                'before': 'bifr',
                'after': 'ftr',
                'during': 'dirin',
                'while': 'uil',
                'since': 'sns',
                'until': 'ntl',
                'early': 'rli',
                'late': 'lit',
                'morning': 'mrnin',
                'afternoon': 'ftrnun',
                'evening': 'vnin',
                'night': 'nit',
                'day': 'di',
                'days': 'diz',
                'week': 'uik',
                'weeks': 'uiks',
                'month': 'mnf',
                'months': 'mnfs',
                'year': 'ir',
                'years': 'irs',
                'time': 'tim',
                'times': 'timz',
                'hour': 'ur',
                'hours': 'urs',
                'minute': 'mnit',
                'minutes': 'mnits',
                'second': 'sknd',
                'seconds': 'skndz',
                'moment': 'mumnt',
                'forever': 'forvr',
                // Numbers and quantities
                'first': 'frst',
                'second': 'sknd',
                'third': 'frd',
                'last': 'lst',
                'next': 'nkst',
                'other': 'dr',
                'another': 'andr',
                'many': 'mni',
                'much': 'mtch',
                'more': 'mr',
                'most': 'must',
                'less': 'ls',
                'least': 'list',
                'few': 'fi',
                'little': 'ltol',
                'some': 'sm',
                'any': 'ni',
                'every': 'vri',
                'each': 'tch',
                'all': 'l',
                'both': 'buf',
                'half': 'rf',
                'enough': 'inf',
                'only': 'nli',
                // Common adjectives
                'good': 'gd',
                'better': 'btr',
                'best': 'bst',
                'bad': 'bd',
                'worse': 'urs',
                'new': 'ni',
                'old': 'uld',
                'young': 'ing',
                'great': 'grit',
                'small': 'sml',
                'large': 'lrdj',
                'long': 'lng',
                'short': 'xrt',
                'high': 'ri',
                'low': 'lu',
                'same': 'sim',
                'different': 'dfrent',
                'important': 'imprtnt',
                'easy': 'izi',
                'hard': 'rrd',
                'difficult': 'dficlt',
                'simple': 'smpol',
                'possible': 'psibl',
                'impossible': 'impsibl',
                'true': 'tr',
                'false': 'fls',
                'real': 'rl',
                'free': 'fr',
                'full': 'fl',
                'empty': 'mpti',
                'ready': 'rdi',
                'able': 'ibol',
                'sure': 'xr',
                'happy': 'rpi',
                'sad': 'sd',
                'right': 'rit',
                'wrong': 'rng',
                'nice': 'nis',
                'beautiful': 'bitifl',
                'pretty': 'prti',
                'ugly': 'gli',
                'strong': 'strng',
                'weak': 'uik',
                'fast': 'fst',
                'slow': 'slu',
                'hot': 'rt',
                'cold': 'culd',
                'warm': 'urm',
                'cool': 'kul',
                'clean': 'klin',
                'dirty': 'drti',
                'safe': 'sif',
                'dangerous': 'dindjers',
                'quiet': 'kuit',
                'loud': 'lud',
                'clear': 'klr',
                'dark': 'drk',
                'bright': 'brit',
                'white': 'uit',
                'black': 'blk',
                'red': 'rd',
                'blue': 'bl',
                'green': 'grin',
                'yellow': 'ilu',
                'rich': 'rtch',
                'poor': 'pr',
                'sick': 'sk',
                'healthy': 'rlfi',
                'tired': 'tird',
                'hungry': 'rngri',
                'thirsty': 'frsti',
                'angry': 'ngri',
                'afraid': 'afrid',
                'worried': 'urid',
                'excited': 'iksitid',
                'interested': 'ntrestid',
                'boring': 'brin',
                'funny': 'fni',
                'serious': 'sris',
                'crazy': 'crizi',
                'normal': 'nrml',
                'special': 'spxl',
                'amazing': 'amizin',
                'awesome': 'sm',
                'wonderful': 'underfl',
                'terrible': 'tribl',
                'horrible': 'rribl',
                'perfect': 'prfekt',
                'favorite': 'fivrit',
                'famous': 'fims',
                'popular': 'ppulr',
                'recent': 'rsnt',
                'modern': 'mdrn',
                'ancient': 'inxnt',
                'current': 'krnt',
                // Common nouns
                'thing': 'fng',
                'things': 'fngz',
                'something': 'smfng',
                'anything': 'nifng',
                'nothing': 'nfng',
                'everything': 'vrifng',
                'person': 'prsn',
                'people': 'ppol',
                'man': 'mn',
                'men': 'mn',
                'woman': 'umn',
                'women': 'umin',
                'child': 'tchild',
                'children': 'tchldren',
                'kid': 'kd',
                'kids': 'kdz',
                'baby': 'bibi',
                'boy': 'bi',
                'girl': 'grl',
                'friend': 'frnd',
                'friends': 'frndz',
                'family': 'fmili',
                'mother': 'mdr',
                'father': 'fdr',
                'parent': 'prnt',
                'parents': 'prnts',
                'brother': 'brdr',
                'sister': 'sstr',
                'husband': 'rzbnd',
                'wife': 'uif',
                'name': 'nim',
                'place': 'plis',
                'home': 'rum',
                'house': 'rus',
                'room': 'rum',
                'door': 'dr',
                'window': 'undu',
                'table': 'tibol',
                'chair': 'tchr',
                'bed': 'bd',
                'car': 'kr',
                'street': 'strit',
                'city': 'sti',
                'country': 'kntri',
                'world': 'urld',
                'school': 'skul',
                'job': 'djb',
                'company': 'kmpni',
                'office': 'fis',
                'phone': 'fun',
                'computer': 'compitr',
                'internet': 'ntrnt',
                'email': 'mil',
                'book': 'bk',
                'paper': 'pipr',
                'water': 'utr',
                'food': 'fud',
                'coffee': 'kfi',
                'tea': 'ti',
                'money': 'mni',
                'price': 'pris',
                'question': 'kustchn',
                'answer': 'nser',
                'problem': 'prblm',
                'idea': 'aida',
                'example': 'igzmpol',
                'way': 'ui',
                'life': 'lif',
                'death': 'df',
                'health': 'rlf',
                'love': 'lv',
                'heart': 'rrt',
                'mind': 'mind',
                'body': 'bdi',
                'head': 'rd',
                'face': 'fis',
                'eye': 'i',
                'eyes': 'iz',
                'hand': 'rnd',
                'hands': 'rndz',
                'foot': 'ft',
                'feet': 'fit',
                'voice': 'vis',
                'word': 'urd',
                'words': 'urdz',
                'story': 'stri',
                'news': 'niz',
                'information': 'informixn',
                'music': 'mizik',
                'movie': 'muvi',
                'game': 'guim',
                'sport': 'sprt',
                'art': 'rt',
                'science': 'siens',
                'nature': 'nitchr',
                'weather': 'udr',
                'sun': 'sn',
                'moon': 'mun',
                'star': 'str',
                'sky': 'ski',
                'air': 'r',
                'fire': 'fir',
                'earth': 'rf',
                'sea': 'si',
                'river': 'rvr',
                'mountain': 'muntn',
                'tree': 'tri',
                'flower': 'flur',
                'color': 'klr',
                'light': 'lit',
                'sound': 'sund',
                'reason': 'rizn',
                'fact': 'fkt',
                'truth': 'truf',
                'lie': 'li',
                'secret': 'sikret',
                'dream': 'drim',
                'future': 'fitchr',
                'past': 'pst',
                'present': 'prznt',
                'chance': 'tchns',
                'choice': 'tchis',
                'success': 'sksss',
                'failure': 'filir',
                'mistake': 'mistik',
                'effort': 'fort',
                'result': 'rizlt',
                'effect': 'ifkt',
                'cause': 'kz',
                'difference': 'dfrns',
                'experience': 'iksprins',
                'opportunity': 'oportunti',
                'situation': 'sitchuexn',
                'condition': 'kondxn',
                'relationship': 'rilixnxp',
                'community': 'cominiti',
                'society': 'sosieti',
                'culture': 'kltchr',
                'history': 'rstrori',
                'government': 'gvrnmnt',
                'system': 'sstm',
                'process': 'prsess',
                'service': 'srvis',
                'product': 'prdukt',
                'development': 'divlopmnt',
                'research': 'risrtch',
                'project': 'prdjekt',
                'team': 'tim',
                'member': 'mmbr',
                'leader': 'lidr',
                'support': 'suprt',
                'value': 'vli',
                'benefit': 'bnift',
                'cost': 'kst',
                'quality': 'kuliti',
                'level': 'lvol',
                'type': 'tip',
                'kind': 'kind',
                'form': 'frm',
                'part': 'prt',
                'area': 'ria',
                'point': 'pint',
                'case': 'kis',
                'issue': 'x',
                'event': 'ivnt',
                'activity': 'aktivti',
                'action': 'kxn',
                'decision': 'disjn',
                'plan': 'pln',
                'goal': 'gul',
                'purpose': 'prps',
                'interest': 'ntrest',
                'attention': 'atnxn',
                'focus': 'fuks',
                'control': 'kontrul',
                'power': 'pur',
                'force': 'frs',
                'energy': 'nerdji',
                'ability': 'abliti',
                'skill': 'skl',
                'knowledge': 'nlidj',
                'education': 'edjiukixn',
                'training': 'trinin',
                'practice': 'prktis',
                'test': 'tst',
                'performance': 'perfrmns',
                'market': 'mrket',
                'business': 'bznes',
                'industry': 'ndstri',
                'technology': 'teknlodji',
                'data': 'dita',
                'content': 'kntent',
                'material': 'matrial',
                'resource': 'risrs',
                'source': 'srs',
                'tool': 'tul',
                'feature': 'fitchr',
                'function': 'fnkxn',
                'option': 'pxn',
                'step': 'stp',
                'stage': 'stidj',
                'progress': 'prgrs',
                // Common -ing/-ed words often mispronounced
                'using': 'izin',
                'use': 'iz',
                'uses': 'izes',
                'used': 'izd',
                // Method and related words
                'method': 'mfod',
                'methods': 'mfods',
                // Called and related words
                'call': 'kl',
                'called': 'kld',
                // Comprehensible and related words
                'comprehensible': 'comprinsibel',
                'comprehend': 'comprind',
                'comprehension': 'comprinxn',
                // Input/Output
                'input': 'nput',
                'inputs': 'nputs',
                'output': 'utput',
                'outputs': 'utputs',
                // Language-related words
                'english': 'nglish',
                'spanish': 'spnish',
                'french': 'frnch',
                'german': 'djrmn',
                'chinese': 'tchains',
                'japanese': 'djepans',
                'portuguese': 'portchughs',
                'italian': 'itlin',
                'russian': 'rxn',
                'language': 'lnguedj',
                'languages': 'lnguedjes',
                'speak': 'spik',
                'speaker': 'spikr',
                'speakers': 'spikrs',
                'native': 'nitiv',
                'fluent': 'flent',
                'fluency': 'flensi',
                'accent': 'ksent',
                'pronunciation': 'pronnsiixn',
                'vocabulary': 'vokbiulari',
                'grammar': 'grmr',
                'sentence': 'sntens',
                'sentences': 'sntenses',
                'phrase': 'friz',
                'phrases': 'frizes',
                // Education and teaching words
                'student': 'stident',
                'students': 'stidents',
                'teacher': 'ttchr',
                'teachers': 'ttchrs',
                'lesson': 'lsn',
                'lessons': 'lsnz',
                'class': 'kls',
                'classes': 'klses',
                'course': 'krs',
                'courses': 'krses',
                'study': 'stdi',
                'studies': 'stdis',
                'studied': 'stdid',
                'studying': 'stdiin',
                'review': 'rivu',
                'reviews': 'rivuz',
                'reviewed': 'rivud',
                'reviewing': 'rivuin',
                'explain': 'iksplin',
                'explains': 'iksplins',
                'explained': 'iksplind',
                'explaining': 'iksplinin',
                'example': 'igzmpol',
                'examples': 'igzmpols',
                'exercise': 'ksersaiz',
                'exercises': 'ksersaizez',
                'homework': 'rumurk',
                'assignment': 'asinment',
                // Podcast-specific words
                'episode': 'pisud',
                'episodes': 'pisuds',
                'host': 'rust',
                'hosts': 'rusts',
                'guest': 'gust',
                'guests': 'gusts',
                'interview': 'nterviu',
                'interviews': 'ntervius',
                'interviewer': 'ntervur',
                'conversation': 'convrsixn',
                'conversations': 'convrsixns',
                'discussion': 'diskxn',
                'discussions': 'diskxns',
                'topic': 'tpik',
                'topics': 'tpiks',
                'subscriber': 'sbskribr',
                'subscribers': 'sbskribrs',
                'subscribe': 'sbskrib',
                'subscribed': 'sbskribd',
                'channel': 'tchnol',
                'channels': 'tchnols',
                'video': 'vdiu',
                'videos': 'vdius',
                'audio': 'diu',
                'record': 'rekrd',
                'recording': 'rekrdin',
                'recorded': 'rekrdid',
                'microphone': 'mikrofun',
                'headphones': 'rdfuns',
                'studio': 'stidiu',
                // Common internet/tech words
                'online': 'onlin',
                'offline': 'oflin',
                'website': 'ubsait',
                'webpage': 'ubpidj',
                'browser': 'bruzr',
                'application': 'plikixn',
                'app': 'p',
                'apps': 'ps',
                'software': 'sftur',
                'hardware': 'rrdur',
                'password': 'psurd',
                'username': 'izernim',
                'account': 'akunt',
                'login': 'lguin',
                'logout': 'logut',
                'signup': 'sinp',
                'profile': 'prufil',
                'settings': 'stins',
                'notification': 'noutifikixn',
                'notifications': 'noutifikixns',
                'message': 'msidj',
                'comment': 'kment',
                'comments': 'kments',
                'post': 'pust',
                'posts': 'pusts',
                'update': 'pdit',
                'updates': 'pdits',
                'updated': 'pditid',
                'version': 'vrjn',
                'link': 'lnk',
                'links': 'lnks',
                'button': 'btn',
                'buttons': 'btns',
                'screen': 'skrin',
                'keyboard': 'kibrd',
                'mouse': 'mus',
                // Additional commonly mispronounced words
                'idea': 'aida',
                'ideas': 'aidas',
                'because': 'bikz',
                'about': 'abut',
                'without': 'uidut',
                'through': 'fr',
                'enough': 'inf',
                'although': 'oldu',
                'thought': 'ft',
                'should': 'xd',
                'would': 'ud',
                'could': 'kd',
                'might': 'mit',
                'must': 'mst',
                'shall': 'xl',
                'will': 'ul',
                'probably': 'prbabli',
                'actually': 'ktchuali',
                'really': 'rli',
                'basically': 'bisikali',
                'definitely': 'dfinitli',
                'especially': 'ispxali',
                'exactly': 'igzktli',
                'absolutely': 'bsoltli',
                'completely': 'compltli',
                'certainly': 'srtnli',
                'perhaps': 'prrps',
                'maybe': 'mibi',
                'however': 'rauvr',
                'therefore': 'drfr',
                'anyway': 'niui',
                'anyway': 'niui',
                'somewhere': 'smur',
                'anywhere': 'niur',
                'everywhere': 'vriur',
                'nowhere': 'nuur',
                'someone': 'smun',
                'anyone': 'niun',
                'everyone': 'vriun',
                'nobody': 'nubdi',
                'somebody': 'smbdi',
                'anybody': 'nibdi',
                'everybody': 'vribdi',
            };

            // Split into words and process
            const words = result.split(/(\s+|[.,!?;:'"()-])/);

            // Process each word
            const processedWords = words.map(word => {
                const cleanWord = word.toLowerCase().replace(/[.,!?;:'"()-]/g, '');

                // Check if word is in our map
                if (wordMap[cleanWord]) {
                    return wordMap[cleanWord];
                }

                // If not in map, apply phonetic rules
                return applyPhoneticRules(word);
            });

            result = processedWords.join('');

            // DOUBLE CHECK: Validate and fix common phonetic errors
            result = validatePhonetic(result);

            // Add rhythm separators (/) every 3-4 words for better reading
            result = addRhythmSeparators(result);

            return result;
        }

        // Double check function to catch and fix common phonetic errors
        function validatePhonetic(text) {
            if (!text) return text;

            let result = text;

            // Common error patterns and their corrections
            // Format: [wrong pattern, correct replacement]
            const corrections = [
                // "using" pattern errors - sn should be izin for -using words
                [/sn/g, 'izin'],
                [/sng/g, 'izin'],

                // "ge/gi" at end of words should sound like "dj" not hard "g"
                // e.g. "page" = pidj, not "pig"
                [/gu$/g, 'dj'],
                [/gu$/g, 'dj'],
                [/g$/g, 'dj'],

                // Soft G before E and I (in middle of words)
                [/gn/g, 'djn'],
                [/gr/g, 'djr'],
                [/gn/g, 'djn'],
                [/gr/g, 'djr'],

                // "ce" sound at end should be "s" not "k"
                [/kss$/g, 'sss'],
                [/ks$/g, 'ss'],

                // Double consonants in phonetic output (shouldn't happen)
                [/kk/g, 'k'],
                [/tt/g, 't'],
                [/pp/g, 'p'],
                [/ss([^])/g, 's$1'], // keep 'ss' before  for words like "success"
                [/ff/g, 'f'],
                [/ll/g, 'l'],
                [/rr/g, 'r'],
                [/nn/g, 'n'],
                [/mm/g, 'm'],

                // Common word endings corrections
                // -ble should be -bol, not -bl
                [/bl$/g, 'bol'],
                [/bls$/g, 'bols'],

                // -tion should be -xn
                [/tn$/g, 'xn'],
                [/tin$/g, 'xn'],

                // -sion should be -jn
                [/sn$/g, 'jn'],
                [/sin$/g, 'jn'],

                // -age ending should be -idj
                [/ig$/g, 'idj'],
                [/g$/g, 'idj'],
                [/dj$/g, 'idj'],

                // -dge ending should be -dj
                [/ddj$/g, 'dj'],
                [/dg$/g, 'dj'],

                // "J" sound corrections (J should sound like "dj")
                [/^j([aeiou])/gi, 'dj$1'],

                // "ce" and "ci" should be soft (s sound), not k
                [/ki([^kgmpbdtf])/g, 'si$1'], // "cei" patterns
                [/k([^kgmpbdtf])/g, 's$1'],   // "ci" patterns like "city"

                // Words starting with "kn" - k is silent
                [/^kn/g, 'n'],

                // Words starting with "wr" - w is silent
                [/^ur([aeiou])/g, 'r$1'],

                // "qu" should be "ku" not "kiu"
                [/ki([aeiou])/g, 'ku$1'],

                // "wh" should be "u" (or "r" for aspirated)
                [/^urit/g, 'rit'], // white, write
                [/^urt/g, 'ut'],   // what

                // Fix common vowel combinations that get mangled
                [//g, ''],
                [//g, ''],
                [//g, ''],
                [//g, ''],
                [//g, ''],

                // "ould" words (should, would, could)
                [/xuld/g, 'xd'],
                [/uuld/g, 'ud'],
                [/kuld/g, 'kd'],

                // Fix "-ing" endings that might have gotten wrong
                [/ng$/g, 'in'],
                [/ngz$/g, 'inz'],

                // "ph" should always be "f"
                [/ph/g, 'f'],

                // "gh" in middle/end of word is usually silent or "f"
                [/grt$/g, 't'], // thought
                [/t$/g, 'it'],  // light, night (when ight was mangled)

                // Article "a" should be "" or "a" not ""
                // Only at word boundaries
                [/  ([bcdfghjklmnpqrstvwxyz])/g, ' a $1'],

                // Fix double spaces
                [/  +/g, ' '],
            ];

            // Apply all corrections
            for (const [pattern, replacement] of corrections) {
                result = result.replace(pattern, replacement);
            }

            return result;
        }

        function addRhythmSeparators(text) {
            if (!text) return '';

            // Split by existing punctuation first to preserve natural pauses
            // Keep commas, periods, etc. as natural separators
            const parts = text.split(/([,;:.!?])/);

            return parts.map(part => {
                // If it's punctuation, keep it
                if (part.match(/^[,;:.!?]$/)) {
                    return part;
                }

                // Split into words
                const words = part.trim().split(/\s+/).filter(w => w.length > 0);

                if (words.length <= 4) {
                    return part; // Don't add separators for short phrases
                }

                // Group words (3-4 words per group)
                const groups = [];
                let currentGroup = [];

                for (let i = 0; i < words.length; i++) {
                    currentGroup.push(words[i]);

                    // Create a group every 3-4 words
                    if (currentGroup.length >= 3 && (currentGroup.length >= 4 || i === words.length - 1 || words.length - i <= 3)) {
                        groups.push(currentGroup.join(' '));
                        currentGroup = [];
                    }
                }

                // Add remaining words
                if (currentGroup.length > 0) {
                    // If last group is very small (1-2 words), merge with previous
                    if (currentGroup.length <= 2 && groups.length > 0) {
                        groups[groups.length - 1] += ' ' + currentGroup.join(' ');
                    } else {
                        groups.push(currentGroup.join(' '));
                    }
                }

                return groups.join(' / ');
            }).join('');
        }

        function applyPhoneticRules(word) {
            if (!word || word.match(/^\s+$/) || word.match(/^[.,!?;:'"()-]+$/)) {
                return word;
            }

            let result = word.toLowerCase();

            // Order matters! Apply more specific rules first

            // Silent letters and special combinations
            result = result.replace(/ght/g, 't');
            result = result.replace(/ough/g, 'u');
            result = result.replace(/tion/g, 'xn');
            result = result.replace(/sion/g, 'jn');
            result = result.replace(/ture/g, 'tchr');
            result = result.replace(/sure/g, 'jr');
            result = result.replace(/cious/g, 'xs');
            result = result.replace(/tious/g, 'xs');

            // TH sounds
            result = result.replace(/th([aeiou])/g, 'd$1');
            result = result.replace(/th/g, 'f');

            // Vowel combinations
            result = result.replace(/oa/g, 'u');
            result = result.replace(/ea/g, '');
            result = result.replace(/ee/g, '');
            result = result.replace(/oo/g, '');
            result = result.replace(/ou/g, 'u');
            result = result.replace(/ow$/g, 'u');
            result = result.replace(/ow/g, 'u');
            result = result.replace(/oi/g, 'i');
            result = result.replace(/oy/g, 'i');
            result = result.replace(/ai/g, 'i');
            result = result.replace(/ay/g, 'i');
            result = result.replace(/au/g, '');
            result = result.replace(/aw/g, '');
            result = result.replace(/ie/g, '');
            result = result.replace(/ei/g, 'i');
            result = result.replace(/ue$/g, '');
            result = result.replace(/ue/g, 'i');

            // Consonant combinations
            result = result.replace(/ch/g, 'tch');
            result = result.replace(/sh/g, 'x');
            result = result.replace(/ph/g, 'f');
            result = result.replace(/wh/g, 'u');
            result = result.replace(/ck/g, 'k');
            result = result.replace(/ng$/g, 'n');
            result = result.replace(/wr/g, 'r');
            result = result.replace(/kn/g, 'n');
            result = result.replace(/mb$/g, 'm');
            result = result.replace(/mn$/g, 'm');

            // W sounds
            result = result.replace(/^w/g, 'u');
            result = result.replace(/([^aeiou])w/g, '$1u');

            // Y as vowel
            result = result.replace(/y$/g, 'i');
            result = result.replace(/^y/g, 'i');

            // R sounds (Brazilian style - often silent or soft at end)
            result = result.replace(/er$/g, 'r');
            result = result.replace(/or$/g, 'r');
            result = result.replace(/ar$/g, 'r');
            result = result.replace(/ir$/g, 'r');
            result = result.replace(/ur$/g, 'r');

            // Common endings
            result = result.replace(/ing$/g, 'in');
            result = result.replace(/ed$/g, 'd');
            result = result.replace(/ly$/g, 'li');
            result = result.replace(/ness$/g, 'ns');
            result = result.replace(/ment$/g, 'mnt');
            result = result.replace(/able$/g, 'bol');
            result = result.replace(/ible$/g, 'bol');
            result = result.replace(/ful$/g, 'fl');
            result = result.replace(/less$/g, 'ls');
            result = result.replace(/ous$/g, 's');
            result = result.replace(/ive$/g, 'v');
            result = result.replace(/ize$/g, 'iz');
            result = result.replace(/ise$/g, 'iz');

            // Single vowels (when not caught by combinations)
            result = result.replace(/a([^aeiou])/g, '$1');
            result = result.replace(/e$/g, '');
            result = result.replace(/i([^aeiou])/g, '$1');
            result = result.replace(/u([^aeiou])/g, '$1');

            // H is often silent
            result = result.replace(/^h([aeiou])/g, 'r$1');

            return result;
        }

        // ==================== FLASH CARDS ====================
        let flashcards = [];
        let practiceCards = [];
        let currentPracticeIndex = 0;
        let practiceCorrectCount = 0;
        let practiceWrongCount = 0;

        // SRS (Spaced Repetition System)
        let srsData = {};
        const SRS_LEVELS = [
            { level: 0, intervalDays: 0, name: 'Novo' },
            { level: 1, intervalDays: 1, name: 'Aprendendo' },
            { level: 2, intervalDays: 3, name: 'Revisao' },
            { level: 3, intervalDays: 7, name: 'Familiar' },
            { level: 4, intervalDays: 14, name: 'Conhecido' },
            { level: 5, intervalDays: 30, name: 'Mestre' }
        ];

        function loadSRS() {
            const saved = localStorage.getItem('podtranscode_srs');
            if (saved) {
                srsData = JSON.parse(saved);
            }
        }

        function saveSRS() {
            localStorage.setItem('podtranscode_srs', JSON.stringify(srsData));
        }

        function getSRSLevel(cardId) {
            if (!srsData[cardId]) {
                srsData[cardId] = { level: 0, lastReview: null, nextReview: new Date().toISOString(), reviews: 0 };
            }
            // Ensure reviews counter exists for old data
            if (srsData[cardId].reviews === undefined) {
                srsData[cardId].reviews = 0;
            }
            return srsData[cardId];
        }

        function updateSRSLevel(cardId, correct) {
            const data = getSRSLevel(cardId);
            const now = new Date();

            if (correct) {
                // Move up a level (max 5)
                data.level = Math.min(5, data.level + 1);
            } else {
                // Go back to level 1
                data.level = Math.max(1, data.level - 1);
            }

            // Increment practice counter
            data.reviews = (data.reviews || 0) + 1;

            data.lastReview = now.toISOString();
            const interval = SRS_LEVELS[data.level].intervalDays;
            const nextReview = new Date(now);
            nextReview.setDate(nextReview.getDate() + interval);
            data.nextReview = nextReview.toISOString();

            srsData[cardId] = data;
            saveSRS();
        }

        function isCardDueForReview(cardId) {
            const data = getSRSLevel(cardId);
            if (!data.nextReview) return true;
            return new Date(data.nextReview) <= new Date();
        }

        function getCardsForReview() {
            // Sort cards: least practiced first, then due cards, then by level
            return flashcards
                .map(card => ({
                    ...card,
                    srs: getSRSLevel(card.id),
                    isDue: isCardDueForReview(card.id)
                }))
                .sort((a, b) => {
                    // First: least practiced cards first
                    const reviewsDiff = (a.srs.reviews || 0) - (b.srs.reviews || 0);
                    if (reviewsDiff !== 0) return reviewsDiff;
                    // Then: due cards first
                    if (a.isDue && !b.isDue) return -1;
                    if (!a.isDue && b.isDue) return 1;
                    // Finally: by level (lower first)
                    return a.srs.level - b.srs.level;
                });
        }

        function renderSRSIndicator(cardId) {
            const data = getSRSLevel(cardId);
            let dots = '';
            for (let i = 0; i <= 5; i++) {
                const filled = i <= data.level ? 'filled' : '';
                const review = isCardDueForReview(cardId) && i <= data.level ? 'review' : '';
                dots += `<span class="srs-dot ${filled} ${review}"></span>`;
            }
            return `<span class="srs-level">${dots}</span>`;
        }

        // Note: Main init is at the end of the script

        async function updateFlashcardCount() {
            try {
                const response = await fetch(`/api/flashcards?user_id=${currentUserId}`);
                const data = await response.json();
                const count = data.flashcards ? data.flashcards.length : 0;
                document.getElementById('flashcardCount').textContent = count > 0 ? count : '';
            } catch (error) {
                console.error('Error counting flashcards:', error);
            }
        }

        async function addSelectedToFlashcard() {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();

            if (!selectedText) {
                alert('Select a portion of English text first!');
                return;
            }

            // Get the full sentence for context
            const fullSentence = segments[currentIndex]?.text || '';
            const translation = segments[currentIndex]?.translation || '';

            try {
                const response = await fetch(`/api/flashcards?user_id=${currentUserId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phrase: selectedText,
                        context: fullSentence,
                        context_translation: translation
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`"${selectedText}" added to Flash Cards!`);
                    updateFlashcardCount();
                    selection.removeAllRanges();
                } else {
                    alert(data.error || 'Error adding');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function loadFlashcards() {
            try {
                const response = await fetch(`/api/flashcards?user_id=${currentUserId}`);
                const data = await response.json();
                flashcards = data.flashcards || [];

                const container = document.getElementById('flashcardsItems');
                const startBtn = document.getElementById('startPracticeBtn');

                // Count cards due for review
                const dueCount = flashcards.filter(c => isCardDueForReview(c.id)).length;

                if (flashcards.length === 0) {
                    container.innerHTML = `
                        <div class="flashcard-empty">
                            <div class="flashcard-empty-icon"></div>
                            <p>No flash cards yet</p>
                            <p style="font-size: 14px; margin-top: 10px;">
                                During practice, select an expression and click "Add to Flash Cards"
                            </p>
                        </div>
                    `;
                    startBtn.disabled = true;
                } else {
                    // Sort by least practiced first in the list view too
                    const sortedCards = [...flashcards].sort((a, b) => {
                        const aReviews = getSRSLevel(a.id).reviews || 0;
                        const bReviews = getSRSLevel(b.id).reviews || 0;
                        return aReviews - bReviews;
                    });

                    container.innerHTML = sortedCards.map(card => {
                        const srsInfo = getSRSLevel(card.id);
                        const levelName = SRS_LEVELS[srsInfo.level].name;
                        const isDue = isCardDueForReview(card.id);
                        const practiceCount = srsInfo.reviews || 0;
                        return `
                        <div class="flashcard-item ${isDue ? 'due-review' : ''}">
                            <div class="flashcard-item-text">
                                <strong>${card.phrase}</strong> ${renderSRSIndicator(card.id)}
                                <div class="flashcard-item-translation">${card.translation}</div>
                                <div style="font-size: 10px; color: #666; margin-top: 4px;">
                                    ${levelName}  ${practiceCount}x practiced ${isDue ? ' Due for review' : ''}
                                </div>
                            </div>
                            <div class="flashcard-item-actions">
                                <button class="flashcard-delete-btn" onclick="deleteFlashcard('${card.id}')" title="Remove"></button>
                            </div>
                        </div>
                    `}).join('');
                    startBtn.disabled = false;
                    startBtn.innerHTML = dueCount > 0
                        ? `Start Practice (${dueCount} due for review)`
                        : 'Start Practice';
                }

                updateFlashcardCount();
            } catch (error) {
                console.error('Error loading flashcards:', error);
            }
        }

        async function deleteFlashcard(id) {
            if (!confirm('Remove this flash card?')) return;

            try {
                const response = await fetch(`/api/flashcards/${id}?user_id=${currentUserId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadFlashcards();
                }
            } catch (error) {
                alert('Error removing: ' + error.message);
            }
        }

        async function startPractice() {
            if (flashcards.length === 0) return;

            // Use SRS ordering: due cards first, then by level
            practiceCards = getCardsForReview();
            currentPracticeIndex = 0;
            practiceCorrectCount = 0;
            practiceWrongCount = 0;

            // Switch to practice view
            document.getElementById('flashcardsListView').style.display = 'none';
            document.getElementById('flashcardsPracticeView').classList.add('active');

            // Show term column elements (restore all elements that might have been hidden)
            document.getElementById('practiceAudioBtn').style.display = 'flex';
            document.getElementById('practiceRecordBtn').style.display = 'flex';
            document.getElementById('practicePhrasePhonetic').style.display = 'block';
            document.querySelector('.term-column').style.display = 'flex';

            // Show all practice-mini-btns containers (both term and context)
            document.querySelectorAll('.practice-mini-btns').forEach(el => el.style.display = 'flex');

            // Show section labels
            document.querySelectorAll('.practice-section-label').forEach(el => el.style.display = 'block');

            // Show context column and divider (will be hidden per-card if no context)
            const contextColumn = document.querySelector('.context-column');
            if (contextColumn) contextColumn.style.display = 'flex';
            const divider = document.querySelector('.practice-divider.vertical');
            if (divider) divider.style.display = 'block';

            // Context column will be shown/hidden based on each card
            hidePronunciationResult();

            updatePracticeStats();
            showPracticeCard();
        }

        function exitPractice() {
            // Stop any ongoing speech and recording
            speechSynthesis.cancel();
            stopRecording('term');
            stopRecording('context');
            hidePronunciationResult();
            document.getElementById('flashcardsPracticeView').classList.remove('active');
            document.getElementById('flashcardsListView').style.display = 'block';
            loadFlashcards();
        }

        function updatePracticeStats() {
            document.getElementById('practiceCorrect').textContent = practiceCorrectCount;
            document.getElementById('practiceWrong').textContent = practiceWrongCount;
            document.getElementById('practiceProgress').textContent = `${currentPracticeIndex + 1}/${practiceCards.length}`;
        }

        async function showPracticeCard() {
            if (currentPracticeIndex >= practiceCards.length) {
                // Practice complete
                showPracticeComplete();
                return;
            }

            // Hide pronunciation results from previous card
            hidePronunciationResult();
            stopRecording('term');
            stopRecording('context');

            const card = practiceCards[currentPracticeIndex];
            document.getElementById('practicePhrase').textContent = card.phrase;
            document.getElementById('practiceContext').textContent = card.context ? `"${card.context}"` : '';

            // Add phonetic pronunciation (Brazilian Portuguese approximation)
            const phrasePhonetic = toPortuguesePhonetic(card.phrase);
            document.getElementById('practicePhrasePhonetic').textContent = phrasePhonetic;

            // Show/hide context column based on whether context exists
            const hasContext = card.context && card.context.trim();
            const contextColumn = document.querySelector('.context-column');
            const divider = document.querySelector('.practice-divider.vertical');

            if (hasContext) {
                contextColumn.style.display = 'flex';
                if (divider) divider.style.display = 'block';
                const contextPhonetic = toPortuguesePhonetic(card.context);
                document.getElementById('practiceContextPhonetic').textContent = contextPhonetic;
            } else {
                contextColumn.style.display = 'none';
                if (divider) divider.style.display = 'none';
            }

            // Get quiz options from API
            try {
                const response = await fetch(`/api/flashcards/${card.id}/quiz?user_id=${currentUserId}`);
                const data = await response.json();

                const optionsContainer = document.getElementById('practiceOptions');
                optionsContainer.innerHTML = data.options.map((option, index) => `
                    <button class="practice-option" onclick="checkPracticeAnswer(${index}, ${data.correct_index})">
                        ${option}
                    </button>
                `).join('');

                // Hide result and bottom next button (top button always visible)
                document.getElementById('practiceResult').classList.remove('active', 'success', 'fail');
                document.getElementById('nextPracticeBtn').style.display = 'none';

            } catch (error) {
                console.error('Error loading options:', error);
            }
        }

        function checkPracticeAnswer(selectedIndex, correctIndex) {
            const options = document.querySelectorAll('.practice-option');
            const resultDiv = document.getElementById('practiceResult');
            const resultText = document.getElementById('practiceResultText');
            const currentCard = practiceCards[currentPracticeIndex];

            // Disable all options
            options.forEach((opt, i) => {
                opt.classList.add('disabled');
                if (i === correctIndex) {
                    opt.classList.add('correct');
                }
            });

            const isCorrect = selectedIndex === correctIndex;

            // Update SRS level
            updateSRSLevel(currentCard.id, isCorrect);
            const newLevel = getSRSLevel(currentCard.id);
            const levelName = SRS_LEVELS[newLevel.level].name;

            if (isCorrect) {
                practiceCorrectCount++;
                resultDiv.classList.add('active', 'success');
                resultText.textContent = `Correct! Well done! (${levelName})`;
            } else {
                practiceWrongCount++;
                options[selectedIndex].classList.add('wrong');
                resultDiv.classList.add('active', 'fail');
                resultText.textContent = `Incorrect. (${levelName})`;
            }

            updatePracticeStats();
            document.getElementById('nextPracticeBtn').style.display = 'inline-block';
            // Top next button is always visible, no need to show it
        }

        function nextPracticeCard() {
            currentPracticeIndex++;
            if (currentPracticeIndex >= practiceCards.length) {
                showPracticeComplete();
            } else {
                updatePracticeStats();
                showPracticeCard();
            }
        }

        function playPracticeAudio(type = 'term') {
            if (currentPracticeIndex >= practiceCards.length) return;

            const card = practiceCards[currentPracticeIndex];
            const text = type === 'context' ? (card.context || card.phrase) : card.phrase;
            const btn = type === 'context'
                ? document.getElementById('practiceAudioBtnContext')
                : document.getElementById('practiceAudioBtn');

            // Cancel any ongoing speech
            speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = type === 'context' ? 0.85 : 0.9; // Slightly slower for full sentences

            // Try to find an English voice
            const voices = speechSynthesis.getVoices();
            const englishVoice = voices.find(v => v.lang.startsWith('en-'));
            if (englishVoice) {
                utterance.voice = englishVoice;
            }

            utterance.onstart = () => {
                btn.classList.add('playing');
            };

            utterance.onend = () => {
                btn.classList.remove('playing');
            };

            utterance.onerror = () => {
                btn.classList.remove('playing');
            };

            speechSynthesis.speak(utterance);
        }

        // ==================== PRONUNCIATION RECORDING ====================
        let recognition = null;
        let isRecording = false;
        let currentRecordingType = 'term'; // 'term' or 'context'

        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.log('Speech Recognition not supported');
                return null;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognizer = new SpeechRecognition();
            recognizer.lang = 'en-US';
            recognizer.interimResults = false;
            recognizer.maxAlternatives = 1;
            recognizer.continuous = false;

            return recognizer;
        }

        function toggleRecording(type = 'term') {
            if (isRecording && currentRecordingType === type) {
                stopRecording(type);
            } else {
                // Stop any ongoing recording first
                if (isRecording) {
                    stopRecording(currentRecordingType);
                }
                startRecording(type);
            }
        }

        function startRecording(type = 'term') {
            if (currentPracticeIndex >= practiceCards.length) return;

            // Check if Speech Recognition is available
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Your browser does not support voice recognition. Try using Chrome.');
                return;
            }

            currentRecordingType = type;
            const btn = type === 'context'
                ? document.getElementById('practiceRecordBtnContext')
                : document.getElementById('practiceRecordBtn');
            const originalLabel = type === 'context' ? ' Gravar Frase' : ' Gravar Termo';

            // Hide previous result for this type
            hidePronunciationResult(type);

            recognition = initSpeechRecognition();
            if (!recognition) return;

            recognition.onstart = () => {
                isRecording = true;
                btn.classList.add('recording');
                btn.textContent = '';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const confidence = event.results[0][0].confidence;
                comparePronunciation(transcript, confidence, type);
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                stopRecording(type);

                if (event.error === 'no-speech') {
                    showPronunciationError('Could not detect your voice. Try again.', type);
                } else if (event.error === 'audio-capture') {
                    showPronunciationError('Microphone not found. Check permissions.', type);
                } else {
                    showPronunciationError('Recognition error. Try again.', type);
                }
            };

            recognition.onend = () => {
                stopRecording(type);
            };

            try {
                recognition.start();
            } catch (e) {
                console.error('Error starting recognition:', e);
                showPronunciationError('Error starting recording. Try again.', type);
            }
        }

        function stopRecording(type = 'term') {
            isRecording = false;
            const btn = type === 'context'
                ? document.getElementById('practiceRecordBtnContext')
                : document.getElementById('practiceRecordBtn');

            btn.classList.remove('recording');
            btn.textContent = '';

            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    // Ignore errors when stopping
                }
            }
        }

        function comparePronunciation(transcript, confidence, type = 'term') {
            if (currentPracticeIndex >= practiceCards.length) return;

            const card = practiceCards[currentPracticeIndex];
            const originalPhrase = type === 'context'
                ? (card.context || card.phrase).toLowerCase().trim()
                : card.phrase.toLowerCase().trim();
            const spokenPhrase = transcript.toLowerCase().trim();

            // Calculate similarity between original and spoken
            const similarity = calculateSimilarity(spokenPhrase, originalPhrase);

            // Combine with speech recognition confidence
            const finalScore = Math.round((similarity * 0.7 + (confidence * 100) * 0.3));

            // Update pronunciation statistics
            studyStats.pronunciationAttempts++;
            if (finalScore >= 90) {
                studyStats.pronunciationSuccesses++;
            }
            saveStats();
            updateStatsDisplay();

            showPronunciationResult(finalScore, originalPhrase, spokenPhrase, type);
        }

        function showPronunciationResult(score, original, spoken, type = 'term') {
            const suffix = type === 'context' ? 'Context' : 'Term';
            const resultDiv = document.getElementById('pronunciationResult' + suffix);
            const scoreDiv = document.getElementById('pronunciationScore' + suffix);
            const feedbackDiv = document.getElementById('pronunciationFeedback' + suffix);
            const detailsDiv = document.getElementById('pronunciationDetails' + suffix);

            scoreDiv.textContent = `${score}%`;

            // Determine feedback based on score
            resultDiv.classList.remove('excellent', 'good', 'needs-practice');

            if (score >= 85) {
                resultDiv.classList.add('excellent');
                feedbackDiv.textContent = 'Excellent! Your pronunciation is great! ';
            } else if (score >= 60) {
                resultDiv.classList.add('good');
                feedbackDiv.textContent = 'Good job! Keep practicing. ';
            } else {
                resultDiv.classList.add('needs-practice');
                feedbackDiv.textContent = 'Needs more practice. Listen again and try again! ';
            }

            detailsDiv.innerHTML = `
                <strong>You said:</strong> "${spoken}"<br>
                <strong>Original:</strong> "${original}"
            `;

            resultDiv.classList.add('active');
        }

        function showPronunciationError(message, type = 'term') {
            const suffix = type === 'context' ? 'Context' : 'Term';
            const resultDiv = document.getElementById('pronunciationResult' + suffix);
            const scoreDiv = document.getElementById('pronunciationScore' + suffix);
            const feedbackDiv = document.getElementById('pronunciationFeedback' + suffix);
            const detailsDiv = document.getElementById('pronunciationDetails' + suffix);

            scoreDiv.textContent = '';
            feedbackDiv.textContent = message;
            detailsDiv.textContent = '';

            resultDiv.classList.remove('excellent', 'good');
            resultDiv.classList.add('needs-practice', 'active');
        }

        function hidePronunciationResult(type = null) {
            if (type === null || type === 'term') {
                const resultDivTerm = document.getElementById('pronunciationResultTerm');
                resultDivTerm.classList.remove('active', 'excellent', 'good', 'needs-practice');
            }
            if (type === null || type === 'context') {
                const resultDivContext = document.getElementById('pronunciationResultContext');
                resultDivContext.classList.remove('active', 'excellent', 'good', 'needs-practice');
            }
        }

        function showPracticeComplete() {
            const percentage = Math.round((practiceCorrectCount / practiceCards.length) * 100);

            // Stop any ongoing speech and recording
            speechSynthesis.cancel();
            stopRecording('term');
            stopRecording('context');
            hidePronunciationResult();

            document.getElementById('practicePhrase').textContent = 'Practice Completed!';
            document.getElementById('practiceContext').textContent =
                `You got ${practiceCorrectCount} of ${practiceCards.length} correct (${percentage}%)`;

            // Hide term buttons and phonetics
            document.getElementById('practiceAudioBtn').style.display = 'none';
            document.getElementById('practiceRecordBtn').style.display = 'none';
            document.getElementById('practicePhrasePhonetic').style.display = 'none';
            document.querySelectorAll('.practice-section-label').forEach(el => el.style.display = 'none');
            document.querySelector('.practice-mini-btns').style.display = 'none';

            // Hide context column completely
            const contextColumn = document.querySelector('.context-column');
            if (contextColumn) contextColumn.style.display = 'none';
            const divider = document.querySelector('.practice-divider.vertical');
            if (divider) divider.style.display = 'none';

            document.getElementById('practiceOptions').innerHTML = '';
            document.getElementById('practiceResult').classList.remove('active');
            document.getElementById('nextPracticeBtn').style.display = 'none';
            // Top next button remains visible for easy restart

            // Show restart button
            document.getElementById('practiceOptions').innerHTML = `
                <button class="practice-option" onclick="startPractice()" style="grid-column: span 2; background: #ff6b6b; border-color: #ff6b6b;">
                    Practice Again
                </button>
                <button class="practice-option" onclick="exitPractice()" style="grid-column: span 2;">
                    Back to List
                </button>
            `;

            // Update stats
            updateStudyStats(practiceCards.length, practiceCorrectCount);
        }

        // ==================== USER IDENTIFICATION ====================
        function getUserId() {
            let userId = localStorage.getItem('podtranscode_user_id');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
                localStorage.setItem('podtranscode_user_id', userId);
            }
            return userId;
        }

        const currentUserId = getUserId();

        // ==================== STATS & GAMIFICATION ====================
        let studyStats = {
            streak: 0,
            lastStudyDate: null,
            todaySegments: 0,
            totalSegments: 0,
            totalWords: 0,
            totalTimeSeconds: 0,
            accuracyHistory: [],
            dailyGoal: 10,
            bookmarks: [],
            segmentDifficulty: {},
            pronunciationAttempts: 0,
            pronunciationSuccesses: 0
        };

        function loadStats() {
            const saved = localStorage.getItem('podtranscode_stats');
            if (saved) {
                studyStats = { ...studyStats, ...JSON.parse(saved) };
            }
            updateStatsDisplay();
            checkStreak();
        }

        function saveStats() {
            localStorage.setItem('podtranscode_stats', JSON.stringify(studyStats));
        }

        function checkStreak() {
            const today = new Date().toDateString();
            const lastStudy = studyStats.lastStudyDate;

            if (lastStudy) {
                const lastDate = new Date(lastStudy);
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                if (lastStudy === today) {
                    // Same day, keep streak
                } else if (lastDate.toDateString() === yesterday.toDateString()) {
                    // Yesterday, streak continues
                } else {
                    // Streak broken
                    studyStats.streak = 0;
                    studyStats.todaySegments = 0;
                }
            }

            // Reset today's count if new day
            if (studyStats.lastStudyDate !== today) {
                studyStats.todaySegments = 0;
            }

            saveStats();
            updateStatsDisplay();
        }

        function updateStudyStats(segmentCount, correctCount) {
            const today = new Date().toDateString();

            // Update streak
            if (studyStats.lastStudyDate !== today) {
                const lastDate = studyStats.lastStudyDate ? new Date(studyStats.lastStudyDate) : null;
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                if (!lastDate || lastDate.toDateString() === yesterday.toDateString()) {
                    studyStats.streak++;
                } else if (lastDate.toDateString() !== today) {
                    studyStats.streak = 1;
                }
            }

            studyStats.lastStudyDate = today;
            studyStats.todaySegments += segmentCount;
            studyStats.totalSegments += segmentCount;

            // Estimate words (average 10 words per segment)
            studyStats.totalWords += segmentCount * 10;

            // Track accuracy
            if (segmentCount > 0) {
                const accuracy = (correctCount / segmentCount) * 100;
                studyStats.accuracyHistory.push(accuracy);
                // Keep last 100 entries
                if (studyStats.accuracyHistory.length > 100) {
                    studyStats.accuracyHistory.shift();
                }
            }

            saveStats();
            updateStatsDisplay();
        }

        function updateStatsDisplay() {
            // Update main stats panel
            document.getElementById('streakCount').textContent = ` ${studyStats.streak}`;
            document.getElementById('todaySegments').textContent = studyStats.todaySegments;
            document.getElementById('totalWords').textContent = studyStats.totalWords;

            // Calculate average accuracy
            if (studyStats.accuracyHistory.length > 0) {
                const avgAccuracy = Math.round(
                    studyStats.accuracyHistory.reduce((a, b) => a + b, 0) / studyStats.accuracyHistory.length
                );
                document.getElementById('avgAccuracy').textContent = avgAccuracy + '%';
                document.getElementById('totalAccuracy').textContent = avgAccuracy + '%';
            }

            // Update modal stats
            document.getElementById('totalTimeStudied').textContent = Math.round(studyStats.totalTimeSeconds / 60);
            document.getElementById('totalSegments').textContent = studyStats.totalSegments;

            // Update pronunciation stats
            document.getElementById('pronunciationAttempts').textContent = studyStats.pronunciationAttempts || 0;
            document.getElementById('pronunciationSuccesses').textContent = studyStats.pronunciationSuccesses || 0;
            const pronunciationRate = studyStats.pronunciationAttempts > 0
                ? Math.round((studyStats.pronunciationSuccesses / studyStats.pronunciationAttempts) * 100)
                : 0;
            document.getElementById('pronunciationRate').textContent = pronunciationRate + '%';

            // Update daily goal
            const goalProgress = Math.min(100, (studyStats.todaySegments / studyStats.dailyGoal) * 100);
            document.getElementById('dailyGoalFill').style.width = goalProgress + '%';
            document.getElementById('dailyGoalCounter').textContent = `${studyStats.todaySegments}/${studyStats.dailyGoal} sentences`;

            // Set goal selector
            const goalSelect = document.getElementById('dailyGoalSelect');
            if (goalSelect) {
                goalSelect.value = studyStats.dailyGoal;
            }
        }

        function updateDailyGoal() {
            const select = document.getElementById('dailyGoalSelect');
            studyStats.dailyGoal = parseInt(select.value);
            saveStats();
            updateStatsDisplay();
        }

        // ==================== THEME TOGGLE ====================
        let isDarkMode = true;

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('light-mode', !isDarkMode);

            const themeBtn = document.querySelector('.header-right .icon-btn');
            themeBtn.textContent = isDarkMode ? '' : '';

            localStorage.setItem('podtranscode_theme', isDarkMode ? 'dark' : 'light');
        }

        function loadTheme() {
            const saved = localStorage.getItem('podtranscode_theme');
            if (saved === 'light') {
                isDarkMode = false;
                document.body.classList.add('light-mode');
                const themeBtn = document.querySelector('.header-right .icon-btn');
                if (themeBtn) themeBtn.textContent = '';
            }
        }

        // ==================== MODALS ====================
        function showStats() {
            document.getElementById('statsModal').classList.add('active');
        }

        function showShortcuts() {
            document.getElementById('shortcutsModal').classList.add('active');
        }

        function closeModal(event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.classList.remove('active');
            }
        }

        // ==================== LOOP MODE ====================
        function toggleLoopMode() {
            isLoopMode = !isLoopMode;
            const toggle = document.getElementById('loopToggle');
            const checkbox = document.getElementById('loopModeCheckbox');

            toggle.classList.toggle('active', isLoopMode);
            checkbox.checked = isLoopMode;
        }

        // ==================== SEARCH IN TRANSCRIPT ====================
        let searchResults = [];
        let currentSearchIndex = -1;

        function searchInTranscript(event) {
            const query = document.getElementById('searchTranscript').value.toLowerCase().trim();
            const resultsDiv = document.getElementById('searchResults');

            if (!query || query.length < 2) {
                resultsDiv.style.display = 'none';
                searchResults = [];
                return;
            }

            // Find matching segments
            searchResults = segments
                .map((seg, index) => ({ index, segment: seg }))
                .filter(item =>
                    item.segment.text.toLowerCase().includes(query) ||
                    item.segment.translation.toLowerCase().includes(query)
                );

            if (searchResults.length > 0) {
                currentSearchIndex = 0;
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = `${searchResults.length} results found`;

                // Jump to first result on Enter
                if (event.key === 'Enter') {
                    goToSearchResult(0);
                }
            } else {
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = 'No results found';
            }
        }

        function goToSearchResult(index) {
            if (searchResults.length === 0) return;

            currentSearchIndex = index;
            const result = searchResults[currentSearchIndex];

            stopPlayback();
            currentIndex = result.index;
            updateDisplay();
            updateCheckingSection();
        }

        function prevSearchResult() {
            if (searchResults.length === 0) return;
            currentSearchIndex = (currentSearchIndex - 1 + searchResults.length) % searchResults.length;
            goToSearchResult(currentSearchIndex);
        }

        function nextSearchResult() {
            if (searchResults.length === 0) return;
            currentSearchIndex = (currentSearchIndex + 1) % searchResults.length;
            goToSearchResult(currentSearchIndex);
        }

        // ==================== BOOKMARKS ====================
        function toggleBookmark() {
            if (segments.length === 0) return;

            const segmentId = `${currentEpisodeUrl}_${currentIndex}`;
            const btn = document.getElementById('bookmarkBtn');

            const bookmarkIndex = studyStats.bookmarks.findIndex(b => b.id === segmentId);

            if (bookmarkIndex === -1) {
                // Add bookmark
                studyStats.bookmarks.push({
                    id: segmentId,
                    url: currentEpisodeUrl,
                    segmentIndex: currentIndex,
                    text: segments[currentIndex].text,
                    translation: segments[currentIndex].translation,
                    timestamp: new Date().toISOString()
                });
                btn.textContent = '';
                btn.classList.add('bookmarked');
            } else {
                // Remove bookmark
                studyStats.bookmarks.splice(bookmarkIndex, 1);
                btn.textContent = '';
                btn.classList.remove('bookmarked');
            }

            saveStats();
        }

        function updateBookmarkButton() {
            if (segments.length === 0) return;

            const segmentId = `${currentEpisodeUrl}_${currentIndex}`;
            const btn = document.getElementById('bookmarkBtn');

            const isBookmarked = studyStats.bookmarks.some(b => b.id === segmentId);
            btn.textContent = isBookmarked ? '' : '';
            btn.classList.toggle('bookmarked', isBookmarked);
        }

        // ==================== MANUAL BOOKMARKS ====================
        function setManualBookmark() {
            if (!currentEpisodeId || segments.length === 0) return;

            const bookmarks = JSON.parse(localStorage.getItem('manualBookmarks') || '{}');
            bookmarks[currentEpisodeId] = currentIndex;
            localStorage.setItem('manualBookmarks', JSON.stringify(bookmarks));

            updateManualBookmarkButtons();

            // Visual feedback
            const btn = document.getElementById('setBookmarkBtn');
            btn.textContent = ' Set ';
            setTimeout(() => {
                btn.textContent = ' Set';
            }, 1000);
        }

        function gotoManualBookmark() {
            if (!currentEpisodeId) return;

            const bookmarks = JSON.parse(localStorage.getItem('manualBookmarks') || '{}');
            const bookmarkIndex = bookmarks[currentEpisodeId];

            if (bookmarkIndex !== undefined && bookmarkIndex < segments.length) {
                currentIndex = bookmarkIndex;
                updateDisplay();
                updateCheckingSection();
                saveEpisodePosition();

                // Visual feedback
                const btn = document.getElementById('gotoBookmarkBtn');
                btn.classList.add('bookmark-flash');
                setTimeout(() => {
                    btn.classList.remove('bookmark-flash');
                }, 500);
            }
        }

        function updateManualBookmarkButtons() {
            if (!currentEpisodeId) return;

            const bookmarks = JSON.parse(localStorage.getItem('manualBookmarks') || '{}');
            const hasBookmark = bookmarks[currentEpisodeId] !== undefined;
            const gotoBtn = document.getElementById('gotoBookmarkBtn');

            if (hasBookmark) {
                const bookmarkIndex = bookmarks[currentEpisodeId];
                gotoBtn.style.display = 'inline-block';
                gotoBtn.textContent = ` Go #${bookmarkIndex + 1}`;
            } else {
                gotoBtn.style.display = 'none';
            }
        }

        // ==================== DIFFICULTY LEVELS ====================
        function setDifficulty(level) {
            if (segments.length === 0) return;

            const segmentId = `${currentEpisodeUrl}_${currentIndex}`;
            studyStats.segmentDifficulty[segmentId] = level;
            saveStats();
            updateDifficultyButtons();
        }

        function updateDifficultyButtons() {
            if (segments.length === 0) return;

            const segmentId = `${currentEpisodeUrl}_${currentIndex}`;
            const difficulty = studyStats.segmentDifficulty[segmentId];

            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('easy', 'medium', 'hard');
            });

            if (difficulty) {
                const btn = document.querySelector(`.difficulty-btn[onclick*="${difficulty}"]`);
                if (btn) btn.classList.add(difficulty);
            }
        }

        // ==================== EXPORT FUNCTIONS ====================
        function exportToAnki() {
            if (flashcards.length === 0) {
                alert('No flashcards to export!');
                return;
            }

            // Create Anki-compatible CSV format
            let csv = '';
            flashcards.forEach(card => {
                const front = card.phrase.replace(/"/g, '""');
                const back = card.translation.replace(/"/g, '""');
                const context = (card.context || '').replace(/"/g, '""');
                csv += `"${front}";"${back}";"${context}"\n`;
            });

            downloadFile(csv, 'flashcards_anki.txt', 'text/plain');
            alert(`${flashcards.length} flashcards exportados para Anki!`);
        }

        function exportToSRT() {
            if (segments.length === 0) {
                alert('No segments to export!');
                return;
            }

            let srt = '';
            segments.forEach((seg, index) => {
                const startTime = formatSRTTime(seg.start);
                const endTime = formatSRTTime(seg.end);
                srt += `${index + 1}\n`;
                srt += `${startTime} --> ${endTime}\n`;
                srt += `${seg.text}\n`;
                srt += `${seg.translation}\n\n`;
            });

            downloadFile(srt, 'transcript.srt', 'text/srt');
            alert(`${segments.length} segments exported to SRT!`);
        }

        function formatSRTTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 1000);
            return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')},${String(ms).padStart(3, '0')}`;
        }

        function exportBookmarks() {
            if (studyStats.bookmarks.length === 0) {
                alert('No bookmarks to export!');
                return;
            }

            let text = 'BOOKMARKS - ListenUp\n';
            text += '========================\n\n';

            studyStats.bookmarks.forEach((bookmark, index) => {
                text += `${index + 1}. ${bookmark.text}\n`;
                text += `   Translation: ${bookmark.translation}\n`;
                text += `   Date: ${new Date(bookmark.timestamp).toLocaleString('en-US')}\n\n`;
            });

            downloadFile(text, 'bookmarks.txt', 'text/plain');
            alert(`${studyStats.bookmarks.length} bookmarks exported!`);
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ==================== ENHANCED KEYBOARD SHORTCUTS ====================
        document.removeEventListener('keydown', handleKeydown); // Remove old listener
        document.addEventListener('keydown', handleKeydown);

        function handleKeydown(e) {
            // Ignore if typing in input/textarea
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                // Allow Escape to close modals even when typing
                if (e.key === 'Escape') {
                    document.getElementById('shortcutsModal').classList.remove('active');
                    document.getElementById('statsModal').classList.remove('active');
                }
                return;
            }

            switch(e.code) {
                case 'Space':
                    e.preventDefault();
                    // Blur any focused button to prevent double-triggering
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'SELECT') {
                        e.target.blur();
                    }
                    togglePlay();
                    break;
                case 'ArrowLeft':
                    prevSegment();
                    break;
                case 'ArrowRight':
                    nextSegment();
                    break;
                case 'KeyR':
                    // Replay current segment
                    if (segments.length > 0) {
                        stopPlayback();
                        startPlayback();
                    }
                    break;
                case 'KeyL':
                    toggleLoopMode();
                    break;
                case 'KeyB':
                    toggleBookmark();
                    break;
                case 'KeyF':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        document.getElementById('searchTranscript').focus();
                    }
                    break;
                case 'Escape':
                    document.getElementById('shortcutsModal').classList.remove('active');
                    document.getElementById('statsModal').classList.remove('active');
                    break;
            }
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadLibrary();
            updateFlashcardCount();
            loadStats();
            loadTheme();
            loadSRS();

            // Preload voices for Text-to-Speech
            if ('speechSynthesis' in window) {
                speechSynthesis.getVoices();
                speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
            }
        });

        // Update display to also update bookmark and difficulty
        const originalUpdateDisplay = updateDisplay;
        updateDisplay = function() {
            originalUpdateDisplay();
            updateBookmarkButton();
            updateDifficultyButtons();
        };
    </script>
</body>
</html>
